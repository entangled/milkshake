<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Milkshake</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="theme.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header id="title-block-header">
<h1 class="title">Milkshake</h1>
<p class="subtitle">Combining Shake with Dhall to make a minimal build system.</p>
</header>
<div class="row">
        <div class="col-6 col-s-9" id="main">
<p><a href="https://github.com/entangled/milkshake/"><img src="https://img.shields.io/badge/github-clone%20me-%44ee55ff" alt="Github badge" /></a> <a href="https://entangled.github.io/"><img src="https://img.shields.io/badge/entangled-Use%20the%20source!-%2300aeff" alt="Entangled badge" /></a> <a href="https://opensource.org/licenses/Apache-2.0"><img src="https://img.shields.io/badge/License-Apache%202.0-blue.svg" alt="License" /></a> <a href="https://github.com/entangled/milkshake/actions/workflows/haskell.yml"><img src="https://github.com/entangled/milkshake/actions/workflows/haskell.yml/badge.svg" alt="Haskell CI" /></a></p>
<section id="milkshake" class="level1">
<h1>Milkshake</h1>
<p>Experimental prototype: combine Dhall, Shake and FSNotify to create a generic build system that triggers on filesystem events.</p>
<ul>
<li><a href="milkshake.md">Literate source</a></li>
<li><a href="tutorial.md">Tutorial</a></li>
<li><a href="./haddock/index.html">Haddock documentation</a></li>
</ul>
<section id="references" class="level2">
<h2>References</h2>
<ul>
<li><a href="https://shakebuild.com/">Shake</a></li>
<li><a href="https://dhall-lang.org/">Dhall</a></li>
</ul>
</section>
</section>
<section id="tutorial" class="level1">
<h1>Tutorial</h1>
<p>Milkshake uses the Dhall language to specify dependencies between actions. In the most basic operation, we have <code>Target</code> and <code>Action</code>. A <code>Target</code> is usually one or more files, while an <code>Action</code> is a shell script that would generate said <code>Target</code>, after satisfying a set of dependencies (also <code>Target</code>).</p>
<p>The resulting configuration is a list of <code>Action</code>. Since we will add other forms of <em>statements</em> later on, we use some Dhall functions to write out actions. For example, to create a file <code>hello.txt</code> and consequently put it in all caps, could be done as follows:</p>
<div class="named-code-block">
<p>file:say-hello.dhall</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode dhall"><code class="sourceCode dhall"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> ms <span class="fu">=</span> https<span class="fu">://</span>raw<span class="fu">.</span>githubusercontent<span class="fu">.</span>com<span class="fu">/</span>entangled<span class="fu">/</span>milkshake<span class="fu">/</span>master<span class="fu">/</span>data<span class="fu">/</span>Milkshake.dhall</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="kw">in</span> [ ms<span class="fu">.</span>fileAction <span class="st">&quot;hello.txt&quot;</span> ([] <span class="fu">:</span> <span class="dt">List</span> <span class="dt">Text</span>) <span class="st">&#39;&#39;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="st">         echo &quot;Hello, World&quot; &gt; hello.txt</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="st">         &#39;&#39;</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>   , ms<span class="fu">.</span>fileAction <span class="st">&quot;HELLO.TXT&quot;</span> [<span class="st">&quot;hello.txt&quot;</span>] <span class="st">&#39;&#39;</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="st">         tr a-z A-Z &lt; hello.txt &gt; HELLO.TXT</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="st">         &#39;&#39;</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>   , ms<span class="fu">.</span>mainAction [<span class="st">&quot;HELLO.TXT&quot;</span>]</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>]</span></code></pre></div>
</div>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash eval"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">milkshake</span> <span class="at">-1</span> ./say-hello.dhall</span></code></pre></div>
<section id="rules" class="level2">
<h2>Rules</h2>
<p>Because it is not so nice to write out every action explicitely, we can define rules. A rule is a function from input targets to output targets. A rule can be triggered by calling it:</p>
<div class="named-code-block">
<p>file:hello-again.dhall</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode dhall"><code class="sourceCode dhall"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> ms <span class="fu">=</span> https<span class="fu">://</span>raw<span class="fu">.</span>githubusercontent<span class="fu">.</span>com<span class="fu">/</span>entangled<span class="fu">/</span>milkshake<span class="fu">/</span>master<span class="fu">/</span>data<span class="fu">/</span>Milkshake.dhall</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="dt">Text</span><span class="fu">/</span>concat <span class="fu">=</span> https<span class="fu">://</span>prelude<span class="fu">.</span>dhall<span class="fu">-</span>lang<span class="fu">.</span>org<span class="fu">/</span><span class="dt">Text</span><span class="fu">/</span>concat</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="kw">in</span> [ ms<span class="fu">.</span>fileAction <span class="st">&quot;secret.txt&quot;</span> ([] <span class="fu">:</span> <span class="dt">List</span> <span class="dt">Text</span>) <span class="st">&#39;&#39;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="st">         echo &quot;Uryyb, Jbeyq!&quot; &gt; secret.txt</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="st">         &#39;&#39;</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>   , ms<span class="fu">.</span>fileRule <span class="st">&quot;rot13&quot;</span> (\(tgt <span class="fu">:</span> <span class="dt">Text</span>) <span class="ot">-&gt;</span> \(deps <span class="fu">:</span> <span class="dt">List</span> <span class="dt">Text</span>) <span class="ot">-&gt;</span> <span class="st">&#39;&#39;</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="st">         tr a-zA-Z n-za-mN-ZA-M &lt; ${Text/concat deps} &gt; ${tgt}</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="st">         &#39;&#39;</span>)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>   , ms<span class="fu">.</span>fileCall <span class="st">&quot;rot13&quot;</span> <span class="st">&quot;message.txt&quot;</span> [<span class="st">&quot;secret.txt&quot;</span>]</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>   , ms<span class="fu">.</span>mainAction [<span class="st">&quot;message.txt&quot;</span>]</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>]</span></code></pre></div>
</div>
</section>
<section id="includes" class="level2">
<h2>Includes</h2>
<p>Includes allow one to incorporate the contents of one Milkshake file into an other. The nice thing is that the include can be the result of an action. As an example we have here a template that takes a number as an argument:</p>
<div class="named-code-block">
<p>file:template.dhall</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode dhall"><code class="sourceCode dhall"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> ms <span class="fu">=</span> https<span class="fu">://</span>raw<span class="fu">.</span>githubusercontent<span class="fu">.</span>com<span class="fu">/</span>entangled<span class="fu">/</span>milkshake<span class="fu">/</span>master<span class="fu">/</span>data<span class="fu">/</span>Milkshake.dhall</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="kw">in</span> \(x <span class="fu">:</span> <span class="dt">Natural</span>) <span class="ot">-&gt;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    [ ms<span class="fu">.</span>fileAction <span class="st">&quot;answer.txt&quot;</span> ([] <span class="fu">:</span> <span class="dt">List</span> <span class="dt">Text</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;&#39;</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="st">        echo &quot;${Natural/show x}&quot; &gt; answer.txt</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="st">        &#39;&#39;</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    ]</span></code></pre></div>
</div>
<p>The main file imports the generated include</p>
<div class="named-code-block">
<p>file:include.dhall</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode dhall"><code class="sourceCode dhall"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> ms <span class="fu">=</span> https<span class="fu">://</span>raw<span class="fu">.</span>githubusercontent<span class="fu">.</span>com<span class="fu">/</span>entangled<span class="fu">/</span>milkshake<span class="fu">/</span>master<span class="fu">/</span>data<span class="fu">/</span>Milkshake.dhall</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="kw">in</span>  [ ms<span class="fu">.</span>fileAction <span class="st">&quot;include.dhall&quot;</span> ([] <span class="fu">:</span> <span class="dt">List</span> <span class="dt">Text</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;&#39;</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="st">        dhall &lt;&lt;&lt; &quot;./template.dhall 42&quot; &gt; include.dhall</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="st">        &#39;&#39;</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    , ms<span class="fu">.</span>include <span class="st">&quot;include.dhall&quot;</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    , ms<span class="fu">.</span>main [<span class="st">&quot;answer.txt&quot;</span>]</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    ]</span></code></pre></div>
</div>
</section>
<section id="watches" class="level2">
<h2>Watches</h2>
<p>Milkshake can set a number of watches to trigger a file to be built.</p>
<div class="named-code-block">
<p>file:write-secret.dhall</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode dhall"><code class="sourceCode dhall"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> ms <span class="fu">=</span> https<span class="fu">://</span>raw<span class="fu">.</span>githubusercontent<span class="fu">.</span>com<span class="fu">/</span>entangled<span class="fu">/</span>milkshake<span class="fu">/</span>master<span class="fu">/</span>data<span class="fu">/</span>Milkshake.dhall</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="kw">in</span> [ ms<span class="fu">.</span>fileRule <span class="st">&quot;rot13&quot;</span> (\(tgt <span class="fu">:</span> <span class="dt">Text</span>) <span class="ot">-&gt;</span> \(deps <span class="fu">:</span> <span class="dt">List</span> <span class="dt">Text</span>) <span class="ot">-&gt;</span> <span class="st">&#39;&#39;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="st">         tr a-zA-Z n-za-mN-ZA-M &lt; ${Text/concat deps} &gt; ${tgt}</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="st">         &#39;&#39;</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>   , ms<span class="fu">.</span>fileCall <span class="st">&quot;rot13&quot;</span> <span class="st">&quot;secret.txt&quot;</span> [<span class="st">&quot;message.txt&quot;</span>]</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>   , ms<span class="fu">.</span>watch [<span class="st">&quot;message.txt&quot;</span>] (ms<span class="fu">.</span><span class="dt">Target.File</span> <span class="st">&quot;secret.txt&quot;</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>]</span></code></pre></div>
</div>
<p>Now, run:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">milkshake</span> ./wait.dhall</span></code></pre></div>
<p>This will always keep your encoded message up-to-date!</p>
</section>
</section>
<section id="milkshake-1" class="level1">
<h1>Milkshake</h1>
<p>A normal build system is mostly file-system based. Every task is designated a target file and a list of dependencies. When a file somewhere down the line is updated, you rerun <code>make</code> and only the affected part of the dependency tree is updated, like so:</p>
<p><img src="fig/build-graph.svg" class="figure" alt="" /></p>
<p>This simple principle can be written down in a <code>Makefile</code></p>
<div class="named-code-block">
<p>«example-makefile»</p>
<pre class="make"><code>b: a
        &lt;&lt;create-b-from-a&gt;&gt;

e: b c
        &lt;&lt;create-e-from-b-and-c&gt;&gt;

f: d
        &lt;&lt;create-d-from-f&gt;&gt;

g: e f
        &lt;&lt;create-g-from-e-and-f&gt;&gt;</code></pre>
</div>
<p>All dependencies in Figure {@fig:dependency-graph} are listed in <code>&lt;&lt;example-makefile&gt;&gt;</code> including the recipes for each step (in the shape of some shell script). Since we’re committed to a <em>Dhall</em> configuration file, we need to write down a similar structure in the Dhall language.</p>
<section id="cases--persona" class="level2">
<h2>Cases / Persona</h2>
<section id="me" class="level3">
<h3>Me</h3>
<p>A theorist involved in modelling (astro)physical systems.</p>
<p>Needs:</p>
<ul>
<li>A model, a code: Entangled handles this beautifully.</li>
<li>Building the code: we use a <code>Makefile</code>, or alternatively <code>meson</code> to coordinate building C++. For new projects Rust may be a better choice and building is handled by <code>cargo</code>. The availability of build systems in modern languages obliviates the need for complicated build system functionality in Entangled.</li>
<li>Running the code:
<ul>
<li>traditionally in bash</li>
<li>more complicated workflows: link C++ to Python interface, build a notebook</li>
<li>Can we encapsulate some of the workflow in the text, such that the analysis merges fluently with the text?</li>
</ul></li>
<li>Visualisation:
<ul>
<li>gnuplot</li>
<li>python + matplotlib</li>
<li>paraview, is it scriptable?</li>
<li>blender</li>
</ul></li>
</ul>
</section>
</section>
<section id="a-minimal-build-system" class="level2">
<h2>A minimal build system</h2>
<p>By no means should we aim for the level of features found in GNU Make. A more approachable target is <em>Ninja</em>. We will still discuss these features using Make syntax.</p>
<section id="variables" class="level3">
<h3>Variables</h3>
<p>Variables and string interpolation are supported by Dhall, so we won’t have to. In Make you would say</p>
<div class="named-code-block">
<p>«compiling-c-make»</p>
<pre class="make"><code>cflags := -Wall

%.o: %.c
        gcc $(cflags) -c $&lt; -o $@</code></pre>
</div>
<p>In Dhall this would be achieved by,</p>
<div class="named-code-block">
<p>«compiling-c-dhall»</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode dhall"><code class="sourceCode dhall"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> cflags <span class="fu">=</span> <span class="st">&quot;-Wall&quot;</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="kw">in</span> { targets <span class="fu">=</span> [</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>        { target <span class="fu">=</span> <span class="st">&quot;hello.o&quot;</span>, dependencies <span class="fu">=</span> [<span class="st">&quot;hello.c&quot;</span>], script <span class="fu">=</span> <span class="st">&#39;&#39;</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="st">              gcc ${cflags} -c hello.c -o hello.o&#39;&#39;</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>        } ]</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>   }</span></code></pre></div>
</div>
</section>
<section id="rules-1" class="level3">
<h3>Rules</h3>
<p>A rule is a generic recipe for a set of specific targets. In the example above, there is a rule that describes how to compile a c-source file into an object file. It is a short-hand for every c-file in the distribution. We could keep the Make syntax for describing a pattern for the rule, but for the expansion we have could also use a Dhall function. Since we’re using Shake however, we can also have Shake do the expansion.</p>
<div class="named-code-block">
<p>«shake-snippet»</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">do</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>   <span class="st">&quot;_build//*.o&quot;</span> <span class="op">%&gt;</span> \out <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> c <span class="ot">=</span> dropDirectory1 <span class="op">$</span> out <span class="op">-&lt;.&gt;</span> <span class="st">&quot;c&quot;</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>        need [c]</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>        cmd_ <span class="st">&quot;gcc -c&quot;</span> [c] <span class="st">&quot;-o&quot;</span> [out]</span></code></pre></div>
</div>
<p>Shake supports a pattern language to match targets against a defined rule. There is no generic method of getting to the patterned name of the dependency. We could use regular expressions to achieve the same effect; not ideal but very powerful. Unfortunately, the state of regex support in Haskell is abismal. A rule definition for compiling c-files could look something like:</p>
<div class="named-code-block">
<p>«rule-definition»</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode dhall"><code class="sourceCode dhall"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> buildDir <span class="fu">=</span> <span class="st">&quot;build&quot;</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> cflags <span class="fu">=</span> <span class="st">&quot;-Wall&quot;</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> compileC <span class="fu">=</span> rule <span class="st">&quot;${buildDir}/%.o&quot;</span> <span class="st">&quot;%.c&quot;</span> </span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>                    \(out <span class="fu">:</span> <span class="dt">Text</span>) <span class="ot">-&gt;</span> \(inp <span class="fu">:</span> <span class="dt">Text</span>) <span class="ot">-&gt;</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>        { target <span class="fu">=</span> out, dependencies <span class="fu">=</span> [ inp ], script <span class="fu">=</span> <span class="st">&#39;&#39;</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="st">          gcc ${cflags} -c ${inp} -o ${out}&#39;&#39;</span> }</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="kw">in</span> {</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>   rules <span class="fu">=</span> [ compileC ]</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<p>On the other hand, we could just defer these more complicated cases to a real build system. We wouldn’t need to support rules and regexes or anything. This is why we have <code>make</code>, <code>cmake</code>, <code>autotools</code>, <code>meson</code>, <code>ninja</code>, <code>jam</code> etc. right? Not to forget about workflow engines/standards like <code>snakemake</code>, <code>cwl</code>, <code>luigi</code>, <code>pegasus</code>, <code>airflow</code>, <code>taverna</code>, etc. Let’s not go down that road! (and then he did)</p>
</section>
<section id="phony-targets" class="level3">
<h3>Phony targets</h3>
<p>Phony targets are targets that are not identified by any file that will be created, but rather are an alias for one or more other targets.We can say any target starting with <code>#</code> is phony. These targets will acquire another meaning in the next section about Entangled, but I see no reason why this namespace shouldn’t double up for phony targets and code fragments.</p>
</section>
</section>
<section id="special-to-entangled" class="level2">
<h2>Special to Entangled</h2>
<p>In the case of <em>Entangled</em>, we have to track dependencies over <em>fragments of code</em> in addition to files.</p>
<p>We may specify a code-fragment by its identifier using <code>#</code> notation.</p>
<p>In the case of a generated target, the name will be a random generated identifier (UUID hex string), and values may be stored in the Entangled database.</p>
<section id="oracle-rules" class="level3">
<h3>Oracle rules</h3>
<p>We need the build system to work with information from the Entangled database. We may choose to have all actions be filesystem based. That would make the workflow inspectable. However, already in current use cases, we put code into fragments without attaching them to file content, and then evaluate that either in Jupyter or by JS code injection. To work with information from the database directly, we would need to use Oracle rules in Shake.</p>
<ul>
<li>[ ] (nice to have) Tab-completion on code block names</li>
</ul>
</section>
<section id="special-targets" class="level3">
<h3>Special targets</h3>
<p>Some actions are triggered by events. By coupling a phony target to an event we can express the entire Entangled workflow in terms of the build system.</p>
<ul>
<li><p><code>tangle</code> on changed file <code>&lt;s&gt;</code></p>
<ul>
<li>update database: <code>entangled insert -s &lt;s&gt;</code></li>
<li>update target files: <code>entangled tangle -a</code></li>
<li>clear orphans: <code>entangled clear-orphans</code></li>
</ul></li>
<li><p><code>stitch</code> on changed file <code>&lt;t&gt;</code></p>
<ul>
<li>update database: <code>entangled insert -t &lt;t&gt;</code></li>
<li>update source files: <code>entangled stitch -a</code></li>
<li>tangle covariant targets: <code>entangled tangle -a</code></li>
</ul></li>
</ul>
<p>Given an up-to-date database we can ask Entangled for the existing dependencies. We already have the <code>list</code> command; now we should duplicate the <code>gcc -MM</code> kind of behaviour to generate a Makefile syntax dependency list on all markdown source and target files. Generating this information needs tracing back through the Markdown files in a way that is just as expensive as tangling or stitching is anyway. We could extend the functionality of <code>entangled list</code> to also list Markdown sources, slightly trivial, but still good to have.</p>
<ul>
<li>[ ] Implement <code>entangled list -s</code></li>
<li>[ ] Implement <code>entangled list -r</code> listing all named references</li>
</ul>
<p>In an extended workflow, the <code>tangle</code> and <code>stitch</code> methods could also trigger compilation, publication etc.</p>
</section>
<section id="process-code-blocks" class="level3">
<h3>Process code blocks</h3>
<p>When we need to process some code block, there are several options.</p>
<ul>
<li><p>Generate embedable content from the codeblock. Example: create SVG using Graphviz’ Dot language. Example: create SVG plot with Gnuplot; bonus: depends on a model being compiled from tangled code. We have <code>entangled tangle -r &lt;ref&gt;</code> input, some script, and then (most often) an SVG or PNG file output, of which we need to know the name.</p></li>
<li><p>Generate injectable content from the codeblock. Example that wouldn’t work with previous method: generate table from data. We have <code>entangled tangle -r &lt;ref&gt;</code> input, some script, and then literal HTML or TeX output. This output needs to be injected into the final document by Pandoc. Either the output is stored into the Entangled database, or a target filename should be extractable using an <code>entangled</code> subcommand, probably hashing the input, build script and dependency hashes.</p></li>
<li><p>Code blocks should list possible file dependencies. If data changes, output changes. In effect, a code block becomes a build-target itself. Do we have syntax for listing dependencies?</p></li>
<li><p>[ ] Check pandoc accepted syntax for entering list of file names</p></li>
<li><p>[ ] Check how we can make this work with <code>pandoc-fignos</code></p></li>
</ul>
<div class="sourceCode" id="cb13"><pre class="sourceCode markdown"><code class="sourceCode markdown"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a> <span class="in">``` {.gnuplot #plot-data depends=data.txt}</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="in"> set term svg</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="in"> set xrange [0:2*pi]</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="in"> plot sin(x), &quot;data.txt&quot; u 1:2 w lp</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="in"> ```</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a> <span class="al">![Data compared with $sin(x)$.](fig/plot-data-sin.svg)</span>{#data-sin using=#plot-data}</span></code></pre></div>
<p>Such an installation could then be configured by having a rule:</p>
<div class="named-code-block">
<p>«gnuplot-rule»</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode dhall"><code class="sourceCode dhall"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> gnuplot <span class="fu">=</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    { match <span class="fu">=</span> <span class="dt">Match.Class</span> <span class="st">&quot;gnuplot&quot;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    , script <span class="fu">=</span> \(out <span class="fu">:</span> <span class="dt">Text</span>) <span class="ot">-&gt;</span> \(inp <span class="fu">:</span> <span class="dt">Text</span>) <span class="ot">-&gt;</span> <span class="st">&#39;&#39;</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="st">          gnuplot ${inp} &gt; ${out}&#39;&#39;</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="kw">in</span>  { scriptClasses <span class="fu">=</span> [ gnuplot ]</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    }</span></code></pre></div>
</div>
<p>The build system would then write the content of <code>#plot-sine</code> to a temporary file (with a consistent name, so we can do caching), run the script etc.</p>
<div class="named-code-block">
<p>file:test/basic/rules.dhall</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode dhall"><code class="sourceCode dhall"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="dt">Target</span> <span class="fu">:</span> <span class="dt">Type</span> <span class="fu">=</span> <span class="fu">&lt;</span> <span class="dt">File</span> <span class="fu">:</span> <span class="dt">Text</span> <span class="fu">|</span> <span class="dt">Eval</span> <span class="fu">:</span> <span class="dt">Text</span> <span class="fu">&gt;</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="dt">Rule</span> <span class="fu">:</span> <span class="dt">Type</span> <span class="fu">=</span> { target <span class="fu">:</span> <span class="dt">Text</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>                  , dependencies <span class="fu">:</span> <span class="dt">List</span> <span class="dt">Text</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>                  , script <span class="fu">:</span> <span class="dt">Text</span> } </span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> file <span class="fu">=</span> \(target <span class="fu">:</span> <span class="dt">Text</span>) <span class="ot">-&gt;</span> \(deps <span class="fu">:</span> <span class="dt">List</span> <span class="dt">Text</span>) <span class="ot">-&gt;</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>           \(script <span class="fu">:</span> <span class="dt">Text</span>) <span class="ot">-&gt;</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>               { target <span class="fu">=</span> <span class="dt">Target.File</span> target</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>               , dependencies <span class="fu">=</span> deps</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>               , script <span class="fu">=</span> script }</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> message <span class="fu">=</span> <span class="st">&quot;Hello, World!&quot;</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="kw">in</span> { shell <span class="fu">=</span> <span class="st">&quot;bash&quot;</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>   , rules <span class="fu">=</span> [</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>        file <span class="st">&quot;hello.txt&quot;</span> ([] <span class="fu">:</span> <span class="dt">List</span> <span class="dt">Text</span>) <span class="st">&#39;&#39;</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a><span class="st">            echo &quot;${message}&quot; &gt; {target}&#39;&#39;</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>   ] }</span></code></pre></div>
</div>
</section>
<section id="bracketed-spans" class="level3">
<h3>Bracketed spans</h3>
<p>We can use bracketed spans to include generated files.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode markdown"><code class="sourceCode markdown"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a> <span class="in">``` {.bash #hello}</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="in"> echo &quot;Hello, World!&quot;</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="in"> ```</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a> <span class="co">[</span><span class="ot">The output of the script.</span><span class="co">]</span>{include=script-output.txt using=#hello}</span></code></pre></div>
</section>
</section>
</section>
<section id="incremental-implementation" class="level1">
<h1>Incremental implementation</h1>
<p>This is an incremental implementation of the ideas outlined above. Each section adds a new feature to Milkshake.</p>
<section id="exceptions" class="level2">
<h2>Exceptions</h2>
<div class="named-code-block">
<p>file:src/Milkshake/Error.hs</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co">{-| Everything related to error handling in Milkshake -}</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">Milkshake.Error</span> (<span class="dt">MilkshakeError</span>(<span class="op">..</span>)) <span class="kw">where</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">RIO</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co">{-| Internal Error type. -}</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="kw">newtype</span> <span class="dt">MilkshakeError</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    <span class="ot">=</span> <span class="dt">ConfigError</span> <span class="dt">Text</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Exception</span> <span class="dt">MilkshakeError</span></span></code></pre></div>
</div>
</section>
<section id="first-layer-targets-and-actions" class="level2">
<h2>First Layer: targets and actions</h2>
<p>We start at the first level. This is where we get a list of things that need to be done and their implied dependencies.</p>
<p>We have a <code>Target</code> that describes an asset. A target can be a file or a database entry. A database entry should have a method of checking existence and content or a stable representation thereof (i.e. a hash). In this sense, a file is just a special case of a databse entry. We can read it using <code>cat</code> and get its modification time using <code>stat -c '%y'</code>. A <code>Target</code> can also be a named reference to an abstraction of an asset. Such an asset may not have an associated content, and would only be run if explicitly asked for. In Make this would be a <code>.PHONY</code> target.</p>
<div class="named-code-block">
<p>«milkshake-target»</p>
<pre class="dhall"><code>let Virtual : Type =
    { name : Text
    , exists : Text    -- Script to check existence
    , content : Text   -- Script to read content
    }

let Target : Type =
    &lt; File : Text
    | Generic : Virtual
    | Phony : Text
    &gt;</code></pre>
</div>
<div class="named-code-block">
<p>«haskell-types»</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">{-| A virtual target is one that is not backed up by a file, but rather by</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co"> something that could be a file. One example would be an entry in an sqlite</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co"> database. This may be a future feature.</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co"> -}</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Virtual</span> <span class="ot">=</span> <span class="dt">Virtual</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    {<span class="ot"> name ::</span> <span class="dt">Text</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    ,<span class="ot"> exists ::</span> <span class="dt">Text</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    ,<span class="ot"> content ::</span> <span class="dt">Text</span> }</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">deriving</span> (<span class="dt">Generic</span>, <span class="dt">Show</span>, <span class="dt">Eq</span>)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">FromDhall</span> <span class="dt">Virtual</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">ToDhall</span> <span class="dt">Virtual</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="co">{-| A target is either a file, some virtual content, or a phony target.</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="co"> -}</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Target</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    <span class="ot">=</span> <span class="dt">File</span> <span class="dt">Text</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> <span class="dt">Generic</span> <span class="dt">Virtual</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> <span class="dt">Phony</span> <span class="dt">Text</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">deriving</span> (<span class="dt">Generic</span>, <span class="dt">Show</span>, <span class="dt">Eq</span>)</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">FromDhall</span> <span class="dt">Target</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">ToDhall</span> <span class="dt">Target</span></span></code></pre></div>
</div>
<p>To generate a target we have an <code>Action</code>. An action has one or more targets, a list of dependencies, and a script.</p>
<div class="named-code-block">
<p>«milkshake-action»</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode dhall"><code class="sourceCode dhall"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="dt">Dependency</span> <span class="fu">=</span> \(<span class="dt">Tgt</span> <span class="fu">:</span> <span class="dt">Type</span>) <span class="ot">-&gt;</span> \(<span class="dt">Dep</span> <span class="fu">:</span> <span class="dt">Type</span>) <span class="ot">-&gt;</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    { target <span class="fu">:</span> <span class="dt">Tgt</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    , dependency <span class="fu">:</span> <span class="dt">Dep</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="dt">Action</span> <span class="fu">:</span> <span class="dt">Type</span> <span class="fu">=</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    { script <span class="fu">:</span> <span class="dt">Optional</span> <span class="dt">Text</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    } <span class="fu">//</span>\\ (<span class="dt">Dependency</span> (<span class="dt">List</span> <span class="dt">Target</span>) (<span class="dt">List</span> <span class="dt">Target</span>))</span></code></pre></div>
</div>
<div class="named-code-block">
<p>«haskell-types»</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">{-| An `Action` is a node in our workflow. -}</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Action</span> <span class="ot">=</span> <span class="dt">Action</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    {<span class="ot"> target ::</span> [ <span class="dt">Target</span> ]          <span class="co">-- ^ list of targets generated by executing the script</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    ,<span class="ot"> dependency ::</span> [ <span class="dt">Target</span> ]      <span class="co">-- ^ list of dependencies</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    ,<span class="ot"> script ::</span> <span class="dt">Maybe</span> <span class="dt">Text</span>          <span class="co">-- ^ the script to execute</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    } <span class="kw">deriving</span> (<span class="dt">Generic</span>, <span class="dt">Show</span>)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">FromDhall</span> <span class="dt">Action</span></span></code></pre></div>
</div>
<p>This system of <code>Content</code>, <code>Target</code> and <code>Action</code> should suffice to describe every single instance of a build sequence.</p>
<p>Given all of the previous considerations, we can start building Milkshake layer on layer. We start with the level 1 system, capable of taking action descriptions and putting them in Shake.</p>
<p>We add helper functions for defining a <code>file</code> action or the <code>main</code> action, which will serve as entry point.</p>
<div class="named-code-block">
<p>file:test/Layer1/schema.dhall</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode dhall"><code class="sourceCode dhall"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="dt">Prelude</span> <span class="fu">=</span> https<span class="fu">://</span>prelude<span class="fu">.</span>dhall<span class="fu">-</span>lang<span class="fu">.</span>org<span class="fu">/</span>v19<span class="fu">.</span><span class="fl">0.0</span><span class="fu">/</span>package<span class="fu">.</span>dhall</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    sha256<span class="fu">:</span>eb693342eb769f782174157eba9b5924cf8ac6793897fc36a31ccbd6f56dafe2</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="dt">List</span><span class="fu">/</span>map <span class="fu">=</span> Prelude.List.map</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="dt">Text</span><span class="fu">/</span>concatSep <span class="fu">=</span> Prelude.Text.concatSep</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="fu">&lt;&lt;</span>milkshake<span class="fu">-</span>target<span class="fu">&gt;&gt;</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="fu">&lt;&lt;</span>milkshake<span class="fu">-</span>action<span class="fu">&gt;&gt;</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> file <span class="fu">=</span> \(target <span class="fu">:</span> <span class="dt">Text</span>) <span class="ot">-&gt;</span> \(deps <span class="fu">:</span> <span class="dt">List</span> <span class="dt">Text</span>) <span class="ot">-&gt;</span> \(script <span class="fu">:</span> <span class="dt">Text</span>) <span class="ot">-&gt;</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    { target <span class="fu">=</span> [ <span class="dt">Target.File</span> target ]</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    , dependency <span class="fu">=</span> <span class="dt">List</span><span class="fu">/</span>map <span class="dt">Text</span> <span class="dt">Target</span> <span class="dt">Target.File</span> deps</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    , script <span class="fu">=</span> <span class="dt">Some</span> script }</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> main <span class="fu">=</span> \(deps <span class="fu">:</span> <span class="dt">List</span> <span class="dt">Text</span>) <span class="ot">-&gt;</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    { target <span class="fu">=</span> [ <span class="dt">Target.Phony</span> <span class="st">&quot;main&quot;</span> ]</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    , dependency <span class="fu">=</span> <span class="dt">List</span><span class="fu">/</span>map <span class="dt">Text</span> <span class="dt">Target</span> <span class="dt">Target.File</span> deps</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    , script <span class="fu">=</span> <span class="dt">None</span> <span class="dt">Text</span> }</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a><span class="kw">in</span> { <span class="dt">Target</span> <span class="fu">=</span> <span class="dt">Target</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>   , <span class="dt">Action</span> <span class="fu">=</span> <span class="dt">Action</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>   , <span class="dt">Virtual</span> <span class="fu">=</span> <span class="dt">Virtual</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>   , file <span class="fu">=</span> file</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>   , main <span class="fu">=</span> main }</span></code></pre></div>
</div>
<section id="example-1-compiling-helloc" class="level3">
<h3>Example 1: compiling hello.c</h3>
<div class="named-code-block">
<p>file:test/Layer1/test1.dhall</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode dhall"><code class="sourceCode dhall"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> ms <span class="fu">=</span> <span class="fu">./</span>schema<span class="fu">.</span>dhall</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="kw">in</span> [ ms<span class="fu">.</span>file <span class="st">&quot;hello&quot;</span> [ <span class="st">&quot;hello.c&quot;</span> ]</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;&#39;</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="st">      gcc hello.c -o hello</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="st">      &#39;&#39;</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>   , ms<span class="fu">.</span>file <span class="st">&quot;out.txt&quot;</span> [ <span class="st">&quot;hello&quot;</span> ]</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;&#39;</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="st">      ./hello &gt; out.txt</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="st">      &#39;&#39;</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>   , ms<span class="fu">.</span>main [ <span class="st">&quot;out.txt&quot;</span> ]</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>   ]</span></code></pre></div>
</div>
<div class="named-code-block">
<p>file:test/Layer1/hello.c</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;Hello, World!</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> EXIT_SUCCESS<span class="op">;</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div>
</section>
<section id="example-2-virtual-targets-databases-nyi" class="level3">
<h3>Example 2: Virtual targets, databases, NYI</h3>
<p>Don’t know if we actually need this. For the moment, keep everything file based.</p>
<div class="named-code-block">
<p>file:test/Layer1/test2.dhall</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode dhall"><code class="sourceCode dhall"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> ms <span class="fu">=</span> <span class="fu">./</span>schema<span class="fu">.</span>dhall</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> entry <span class="fu">=</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    { name <span class="fu">=</span> <span class="st">&quot;entry&quot;</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    , exists <span class="fu">=</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;&#39;</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="st">        test $(sqlite3 test.db &#39;select exists(select 1 from &quot;messages&quot; where &quot;id&quot; is 1)&#39;) == 1&quot;</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="st">        &#39;&#39;</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    , content <span class="fu">=</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;&#39;</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="st">        sqlite3 test.db &#39;select &quot;content&quot; from &quot;messages&quot; where &quot;id&quot; is 1&#39;</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="st">        &#39;&#39;</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    } <span class="fu">:</span> ms<span class="fu">.</span><span class="dt">Virtual</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="kw">in</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    [ ms<span class="fu">.</span>main [ <span class="st">&quot;out.txt&quot;</span> ]</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    , { target <span class="fu">=</span> [ ms<span class="fu">.</span><span class="dt">Target.File</span> <span class="st">&quot;out.txt&quot;</span> ]</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>      , dependency <span class="fu">=</span> [ ms<span class="fu">.</span><span class="dt">Target.Generic</span> entry ]</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>      , script <span class="fu">=</span> <span class="dt">Some</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;&#39;</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a><span class="st">        sqlite3 test.db &#39;select &quot;content&quot; from &quot;messages&quot; where &quot;id&quot; is 1&#39; &gt; out.txt</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a><span class="st">        &#39;&#39;</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>    , { target <span class="fu">=</span> [ ms<span class="fu">.</span><span class="dt">Target.Generic</span> entry ]</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>      , dependency <span class="fu">=</span> [] <span class="fu">:</span> <span class="dt">List</span> ms<span class="fu">.</span><span class="dt">Target</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>      , script <span class="fu">=</span> <span class="dt">Some</span></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;&#39;</span></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a><span class="st">        sqlite3 test.db &#39;create table &quot;messages&quot; (&quot;id&quot; integer primary key, &quot;content text&quot;)&#39;</span></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a><span class="st">        sqlite3 test.db &#39;insert into &quot;messages&quot; (&quot;content&quot;) values (\\&#39;We apologise for the inconvenience\\&#39;)&#39;</span></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a><span class="st">        &#39;&#39;</span></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>    ]</span></code></pre></div>
</div>
</section>
<section id="loading-the-script" class="level3">
<h3>Loading the script</h3>
<div class="named-code-block">
<p>file:src/Milkshake/Data.hs</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co">{-| This submodule contains all type definitions and Dhall counterparts.</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="co"> -}</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE DuplicateRecordFields,OverloadedLabels #-}</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE DerivingStrategies,DerivingVia,DataKinds,UndecidableInstances #-}</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">Milkshake.Data</span> <span class="kw">where</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">RIO</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">RIO.Text</span> <span class="kw">as</span> <span class="dt">T</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">RIO.Map</span> <span class="kw">as</span> <span class="dt">M</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Data.Monoid.Generic</span> (<span class="dt">GenericSemigroup</span>(..), <span class="dt">GenericMonoid</span>(..))</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Dhall</span> (<span class="dt">FromDhall</span>, <span class="dt">ToDhall</span>, <span class="dt">Decoder</span>, union, constructor, auto, input, list)</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;</span>haskell<span class="op">-</span>types<span class="op">&gt;&gt;</span></span></code></pre></div>
</div>
<div class="named-code-block">
<p>file:src/Milkshake/Run.hs</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE DuplicateRecordFields,OverloadedLabels #-}</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="co">{-|</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="co">Contains functions to execute the script using Shake.</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="co"> -}</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">Milkshake.Run</span> <span class="kw">where</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">RIO</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">RIO.Text</span> <span class="kw">as</span> <span class="dt">T</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">RIO.Map</span> <span class="kw">as</span> <span class="dt">M</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Development.Shake</span> (shake, shakeOptions)</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Development.Shake</span> <span class="kw">as</span> <span class="dt">Shake</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Milkshake.Data</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>    ( readStmts,</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>      stmtsToConfig,</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Action</span>(<span class="op">..</span>),</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Call</span>(<span class="op">..</span>),</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Config</span>(<span class="op">..</span>),</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Target</span>(<span class="dt">Phony</span>, <span class="dt">File</span>) )</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Milkshake.Error</span> ( <span class="dt">MilkshakeError</span>(..) )</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a><span class="co">{-| Get `FilePath` from `Target` -}</span></span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a><span class="ot">targetPath ::</span> <span class="dt">Target</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">FilePath</span></span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>targetPath (<span class="dt">File</span> path) <span class="ot">=</span> <span class="dt">Just</span> <span class="op">$</span> T.unpack path</span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>targetPath _ <span class="ot">=</span> <span class="dt">Nothing</span></span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a><span class="co">{-| Checks if target is a file -}</span></span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a><span class="ot">isFileTarget ::</span> <span class="dt">Target</span> <span class="ot">-&gt;</span> <span class="dt">Bool</span></span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>isFileTarget (<span class="dt">File</span> _) <span class="ot">=</span> <span class="dt">True</span></span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>isFileTarget _        <span class="ot">=</span> <span class="dt">False</span></span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a><span class="co">{-| Create `Shake.Rules` from an `Action`.</span></span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a><span class="co"> -}</span></span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a><span class="ot">enter ::</span> <span class="dt">Action</span> <span class="ot">-&gt;</span> <span class="dt">Shake.Rules</span> ()</span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;</span>enter<span class="op">-</span>action<span class="op">&gt;&gt;</span></span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a>enter <span class="dt">Action</span> { target <span class="ot">=</span> ts<span class="op">@</span>(_<span class="op">:</span>_), <span class="op">..</span> }</span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> <span class="fu">all</span> isFileTarget ts <span class="ot">=</span></span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a>          tgtPaths <span class="op">Shake.&amp;%&gt;</span> \_ <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a>              Shake.need <span class="op">$</span> mapMaybe targetPath dependency</span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true" tabindex="-1"></a>              <span class="fu">mapM_</span> runScript script</span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> <span class="fu">otherwise</span>           <span class="ot">=</span> <span class="fu">mempty</span></span>
<span id="cb27-42"><a href="#cb27-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">where</span> tgtPaths <span class="ot">=</span> mapMaybe targetPath ts</span>
<span id="cb27-43"><a href="#cb27-43" aria-hidden="true" tabindex="-1"></a>enter _ <span class="ot">=</span> <span class="fu">mempty</span></span>
<span id="cb27-44"><a href="#cb27-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-45"><a href="#cb27-45" aria-hidden="true" tabindex="-1"></a><span class="co">{-| Helper function that creates a `Shake.Action ()` from a scriptlet. -}</span></span>
<span id="cb27-46"><a href="#cb27-46" aria-hidden="true" tabindex="-1"></a><span class="ot">runScript ::</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Shake.Action</span> ()</span>
<span id="cb27-47"><a href="#cb27-47" aria-hidden="true" tabindex="-1"></a>runScript <span class="ot">=</span> <span class="fu">mapM_</span> (Shake.cmd_ <span class="dt">Shake.Shell</span>) <span class="op">.</span> <span class="fu">lines</span> <span class="op">.</span> T.unpack</span></code></pre></div>
</div>
<section id="enter-actions-into-shake" class="level4">
<h4>Enter actions into Shake</h4>
<p>Actions that have a single file target:</p>
<div class="named-code-block">
<p>«enter-action»</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>enter <span class="dt">Action</span>{ target <span class="ot">=</span> [<span class="dt">File</span> path], <span class="op">..</span> } <span class="ot">=</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    T.unpack path <span class="op">Shake.%&gt;</span> \_ <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>        Shake.need <span class="op">$</span> mapMaybe targetPath dependency</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mapM_</span> runScript script</span></code></pre></div>
</div>
<p>The <code>main</code> target:</p>
<div class="named-code-block">
<p>«enter-action»</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>enter <span class="dt">Action</span> { target <span class="ot">=</span> [<span class="dt">Phony</span> n], <span class="op">..</span> }</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> n <span class="op">==</span> <span class="st">&quot;main&quot;</span> <span class="ot">=</span> Shake.want <span class="op">$</span> mapMaybe targetPath dependency</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;&lt;</span>enter<span class="op">-</span>phony<span class="op">&gt;&gt;</span></span></code></pre></div>
</div>
<div class="named-code-block">
<p>«enter-phony»</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="op">|</span> <span class="fu">otherwise</span>   <span class="ot">=</span> Shake.phony (T.unpack n) <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    Shake.need <span class="op">$</span> mapMaybe targetPath dependency</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mapM_</span> runScript script</span></code></pre></div>
</div>
</section>
<section id="run-in-tmp" class="level4">
<h4>Run in tmp</h4>
<p>For testing, we need to run commands in a temporary environment</p>
<div class="named-code-block">
<p>file:test/Util.hs</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE NoImplicitPrelude,DuplicateRecordFields,OverloadedLabels #-}</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">Util</span> (runInTmp, runWithLogger) <span class="kw">where</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">RIO</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">RIO.Directory</span> (getCurrentDirectory, setCurrentDirectory, copyFile)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">System.FilePath.Glob</span> (glob)</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">RIO.FilePath</span> ((&lt;/&gt;), takeFileName)</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="ot">runInTmp ::</span> <span class="dt">MonadUnliftIO</span> m <span class="ot">=&gt;</span> [<span class="dt">String</span>] <span class="ot">-&gt;</span> m () <span class="ot">-&gt;</span> m ()</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>runInTmp cpy action <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>    paths <span class="ot">&lt;-</span> liftIO <span class="op">$</span> foldMapM glob cpy</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>    withSystemTempDirectory <span class="st">&quot;milkshake-&quot;</span> <span class="op">$</span> \tmp <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>        cwd <span class="ot">&lt;-</span> getCurrentDirectory</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mapM_</span> (\f <span class="ot">-&gt;</span> copyFile f (tmp <span class="op">&lt;/&gt;</span> takeFileName f)) paths</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>        setCurrentDirectory tmp</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>        action</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>        setCurrentDirectory cwd</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a><span class="ot">runWithLogger ::</span> <span class="dt">MonadUnliftIO</span> m <span class="ot">=&gt;</span> <span class="dt">RIO</span> <span class="dt">LogFunc</span> a <span class="ot">-&gt;</span> m a</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>runWithLogger action <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>    logOptions <span class="ot">&lt;-</span> logOptionsHandle stderr <span class="dt">True</span></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>    withLogFunc logOptions (<span class="ot">`runRIO`</span> action)</span></code></pre></div>
</div>
<div class="named-code-block">
<p>file:test/Layer1Spec.hs</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE NoImplicitPrelude,DuplicateRecordFields,OverloadedLabels #-}</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">Layer1Spec</span> (spec) <span class="kw">where</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">RIO</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Test.Hspec</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Milkshake.Data</span> (<span class="dt">Action</span>(..), <span class="dt">Target</span>(..))</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Milkshake.Run</span> (enter)</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Dhall</span> (auto, input)</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Development.Shake</span> (shake, shakeOptions)</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Util</span> (runInTmp)</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a><span class="ot">spec ::</span> <span class="dt">Spec</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>spec <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>    describe <span class="st">&quot;Layer1&quot;</span> <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>        it <span class="st">&quot;can load a list of actions&quot;</span> <span class="op">$</span> runInTmp [<span class="st">&quot;./test/Layer1/*&quot;</span>] <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>            actionList <span class="ot">&lt;-</span> input auto <span class="st">&quot;./test1.dhall&quot;</span><span class="ot"> ::</span> <span class="dt">IO</span> [<span class="dt">Action</span>]</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>            actionList <span class="ot">`shouldSatisfy`</span> <span class="fu">any</span> (\a <span class="ot">-&gt;</span> target (<span class="ot">a ::</span> <span class="dt">Action</span>) <span class="op">==</span> [ <span class="dt">Phony</span> <span class="st">&quot;main&quot;</span> ])</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>        it <span class="st">&quot;can run a list of actions&quot;</span> <span class="op">$</span> runInTmp [<span class="st">&quot;./test/Layer1/*&quot;</span>] <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>            actionList <span class="ot">&lt;-</span> input auto <span class="st">&quot;./test1.dhall&quot;</span><span class="ot"> ::</span> <span class="dt">IO</span> [<span class="dt">Action</span>]</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>            shake shakeOptions (<span class="fu">mapM_</span> enter actionList)</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>            result <span class="ot">&lt;-</span> readFileUtf8 <span class="st">&quot;out.txt&quot;</span></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>            result <span class="ot">`shouldBe`</span> <span class="st">&quot;Hello, World!\n&quot;</span></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>    describe <span class="st">&quot;Virtual Targets&quot;</span> <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>        it <span class="st">&quot;can load&quot;</span> <span class="op">$</span> runInTmp [<span class="st">&quot;./test/Layer1/*&quot;</span>] <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>            actionList <span class="ot">&lt;-</span> input auto <span class="st">&quot;./test2.dhall&quot;</span><span class="ot"> ::</span> <span class="dt">IO</span> [<span class="dt">Action</span>]</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>            actionList <span class="ot">`shouldSatisfy`</span> <span class="fu">any</span> (\a <span class="ot">-&gt;</span> target (<span class="ot">a ::</span> <span class="dt">Action</span>) <span class="op">==</span> [ <span class="dt">Phony</span> <span class="st">&quot;main&quot;</span> ])</span></code></pre></div>
</div>
</section>
</section>
</section>
<section id="second-layer-rules-and-triggers" class="level2">
<h2>Second Layer: rules and triggers</h2>
<p>The second level is when we can generate content, targets or actions based on function applications and patterns. The prime example we have seen before is that of a pattern rule in Make. We’d like to extend that to the use case of running scripts based on code-block content.</p>
<div class="named-code-block">
<p>«milkshake-rule»</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode dhall"><code class="sourceCode dhall"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="dt">Generator</span> <span class="fu">:</span> <span class="dt">Type</span> <span class="fu">=</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">List</span> <span class="dt">Target</span> <span class="ot">-&gt;</span> <span class="dt">List</span> <span class="dt">Target</span> <span class="ot">-&gt;</span> <span class="dt">Optional</span> <span class="dt">Text</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="dt">Rule</span> <span class="fu">:</span> <span class="dt">Type</span> <span class="fu">=</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    { name <span class="fu">:</span> <span class="dt">Text</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    , gen <span class="fu">:</span> <span class="dt">Generator</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    }</span></code></pre></div>
</div>
<div class="named-code-block">
<p>«haskell-types»</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co">{-| Function type for generating a script to convert a `Rule` into a specific</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="co"> `Target`.</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="co"> -}</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">Generator</span> <span class="ot">=</span> [<span class="dt">Target</span>] <span class="ot">-&gt;</span> [<span class="dt">Target</span>] <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Text</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="co">{-| A `Rule` is a parametric `Action`. Given a list of targets and dependencies,</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="co">    the generator creates the corresponding script. -}</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Rule</span> <span class="ot">=</span> <span class="dt">Rule</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>    {<span class="ot"> name ::</span> <span class="dt">Text</span>                  <span class="co">-- ^ a unique name for this rule</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    ,<span class="ot"> gen ::</span> <span class="dt">Generator</span>              <span class="co">-- ^ the generator function for the script</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>    } <span class="kw">deriving</span> (<span class="dt">Generic</span>)</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">FromDhall</span> <span class="dt">Rule</span></span></code></pre></div>
</div>
<p>In the GnuPlot example we saw how we could write down a script and link a figure to that script with <code>{using=#script-id}</code>.</p>
<p>To have this work, we need a pre-pass using Pandoc (see next section) and a query that finds figures that link to scripts.</p>
<p>From a match we need to generate an action, by calling the <code>generator</code> member with a target and a list of dependencies. In the case of a <code>using</code> clause, these are generated by calling Pandoc with a special filter.</p>
<p>In the case of,</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode markdown"><code class="sourceCode markdown"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a> <span class="in">``` {.bash #hello}</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="in"> echo &quot;Hello, World!&quot;</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="in"> ```</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a> <span class="co">[</span><span class="ot">The output of the script.</span><span class="co">]</span>{include=script-output.txt using=#hello}</span></code></pre></div>
<p>the target would be <code>File "script-output.txt"</code> and dependencies <code>[ Block "hello" ]</code> and the generated action would amount to</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode dhall"><code class="sourceCode dhall"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>{ target <span class="fu">=</span> [ <span class="dt">Target.File</span> <span class="st">&quot;script-output.txt&quot;</span> ]</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>, dependencies <span class="fu">=</span> [ <span class="dt">Target.Block</span> <span class="st">&quot;hello&quot;</span> ]</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>, script <span class="fu">=</span> <span class="st">&#39;&#39;</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="st">    entangled tangle -r hello | bash &gt; script-output.txt</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="st">    &#39;&#39;</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<section id="calls" class="level3">
<h3>Calls</h3>
<div class="named-code-block">
<p>«milkshake-trigger»</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode dhall"><code class="sourceCode dhall"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="dt">Call</span> <span class="fu">:</span> <span class="dt">Type</span> <span class="fu">=</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    { name <span class="fu">:</span> <span class="dt">Text</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    } <span class="fu">//</span>\\ (<span class="dt">Dependency</span> (<span class="dt">List</span> <span class="dt">Target</span>) (<span class="dt">List</span> <span class="dt">Target</span>))</span></code></pre></div>
</div>
<div class="named-code-block">
<p>«haskell-types»</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co">{-| The `Call` is like a function call, where the `Rule` is the function</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="co">    and `target` and `dependecy` are the arguments. -}</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Call</span> <span class="ot">=</span> <span class="dt">Call</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    {<span class="ot"> name ::</span> <span class="dt">Text</span>                  <span class="co">-- ^ the name of the rule to trigger</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    ,<span class="ot"> target ::</span> [ <span class="dt">Target</span> ]          <span class="co">-- ^ the targets</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    ,<span class="ot"> dependency ::</span> [ <span class="dt">Target</span> ]      <span class="co">-- ^ the dependencies</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    } <span class="kw">deriving</span> (<span class="dt">Generic</span>, <span class="dt">Show</span>)</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">FromDhall</span> <span class="dt">Call</span></span></code></pre></div>
</div>
</section>
<section id="statements" class="level3">
<h3>Statements</h3>
<p>The choice is between a hierarchical notation, where actions and rules are separated, or to join them in a sum type, so that we can read a list of statements. I chose the latter to make it easier to have an include statement, and also that things are a bit more flexible. We expose the <code>Stmt</code> type only through a series of factory functions, making refactoring very easy.</p>
<div class="named-code-block">
<p>«milkshake-stmt»</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode dhall"><code class="sourceCode dhall"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="dt">Watch</span> <span class="fu">:</span> <span class="dt">Type</span> <span class="fu">=</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>    { paths <span class="fu">:</span> <span class="dt">List</span> <span class="dt">Text</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    , target <span class="fu">:</span> <span class="dt">Target</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="dt">Stmt</span> <span class="fu">:</span> <span class="dt">Type</span> <span class="fu">=</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">&lt;</span> <span class="dt">Action</span>  <span class="fu">:</span> <span class="dt">Action</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">|</span> <span class="dt">Rule</span>    <span class="fu">:</span> <span class="dt">Rule</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">|</span> <span class="dt">Call</span> <span class="fu">:</span> <span class="dt">Call</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">|</span> <span class="dt">Include</span> <span class="fu">:</span> <span class="dt">Text</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">|</span> <span class="dt">Watch</span>   <span class="fu">:</span> <span class="dt">Watch</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">|</span> <span class="dt">Main</span>    <span class="fu">:</span> <span class="dt">List</span> <span class="dt">Text</span> <span class="fu">&gt;</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> action <span class="fu">=</span> \(tgt <span class="fu">:</span> <span class="dt">List</span> <span class="dt">Target</span>) <span class="ot">-&gt;</span> \(dep <span class="fu">:</span> <span class="dt">List</span> <span class="dt">Target</span>) <span class="ot">-&gt;</span> \(script <span class="fu">:</span> <span class="dt">Optional</span> <span class="dt">Text</span>) <span class="ot">-&gt;</span></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Stmt.Action</span> { target <span class="fu">=</span> tgt, dependency <span class="fu">=</span> dep, script <span class="fu">=</span> script }</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> rule <span class="fu">=</span> \(name <span class="fu">:</span> <span class="dt">Text</span>) <span class="ot">-&gt;</span> \(gen <span class="fu">:</span> <span class="dt">Generator</span>) <span class="ot">-&gt;</span></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Stmt.Rule</span> { name <span class="fu">=</span> name, gen <span class="fu">=</span> gen }</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> call <span class="fu">=</span> \(name <span class="fu">:</span> <span class="dt">Text</span>) <span class="ot">-&gt;</span> \(tgt <span class="fu">:</span> <span class="dt">List</span> <span class="dt">Target</span>) <span class="ot">-&gt;</span> \(dep <span class="fu">:</span> <span class="dt">List</span> <span class="dt">Target</span>) <span class="ot">-&gt;</span></span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Stmt.Call</span> { name <span class="fu">=</span> name, target <span class="fu">=</span> tgt, dependency <span class="fu">=</span> dep }</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> include <span class="fu">=</span> <span class="dt">Stmt.Include</span></span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> main <span class="fu">=</span> <span class="dt">Stmt.Main</span></span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> watch <span class="fu">=</span> \(paths <span class="fu">:</span> <span class="dt">List</span> <span class="dt">Text</span>) <span class="ot">-&gt;</span> \(tgt <span class="fu">:</span> <span class="dt">Target</span>) <span class="ot">-&gt;</span></span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Stmt.Watch</span> { paths <span class="fu">=</span> paths, target <span class="fu">=</span> tgt }</span></code></pre></div>
</div>
<p>We’ve reached the limits of GHC’s <code>OverloadedLabels</code> extension to deal with this sum type, so we write an explicit decoder.</p>
<div class="named-code-block">
<p>«haskell-types»</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co">{-| The Milkshake script is an unordered list of statements. The &#39;Stmt&#39; type </span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="co"> encodes statements in a Milkshake script.</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="co"> -}</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Stmt</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    <span class="ot">=</span> <span class="dt">StmtAction</span> <span class="dt">Action</span>         <span class="co">{-^ -}</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> <span class="dt">StmtRule</span> <span class="dt">Rule</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> <span class="dt">StmtCall</span> <span class="dt">Call</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> <span class="dt">StmtInclude</span> <span class="dt">FilePath</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> <span class="dt">StmtMain</span> [<span class="dt">FilePath</span>]</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;&lt;</span>stmt<span class="op">-</span><span class="kw">type</span><span class="op">&gt;&gt;</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a><span class="co">{-| To decode a list of Milkshake statements from the Dhall configuration</span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a><span class="co">    use this decoder.</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a><span class="co">  &gt;&gt;&gt; input (list stmt) &quot;(entangled.dhall).milkshake&quot;</span></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a><span class="co">  -}</span></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a><span class="ot">stmt ::</span> <span class="dt">Decoder</span> <span class="dt">Stmt</span></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>stmt <span class="ot">=</span> union (</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>       (<span class="dt">StmtAction</span>  <span class="op">&lt;$&gt;</span> constructor <span class="st">&quot;Action&quot;</span> auto)</span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;&gt;</span> (<span class="dt">StmtRule</span>    <span class="op">&lt;$&gt;</span> constructor <span class="st">&quot;Rule&quot;</span> auto)</span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;&gt;</span> (<span class="dt">StmtCall</span> <span class="op">&lt;$&gt;</span> constructor <span class="st">&quot;Call&quot;</span> auto)</span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;&gt;</span> (<span class="dt">StmtInclude</span> <span class="op">&lt;$&gt;</span> constructor <span class="st">&quot;Include&quot;</span> auto)</span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;&gt;</span> (<span class="dt">StmtMain</span>    <span class="op">&lt;$&gt;</span> constructor <span class="st">&quot;Main&quot;</span> auto)</span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;&lt;</span>stmt<span class="op">-</span>decoder<span class="op">&gt;&gt;</span></span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a><span class="co">{-| Read a list of statements from a script. -}</span></span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a><span class="ot">readStmts ::</span> (<span class="dt">MonadIO</span> m) <span class="ot">=&gt;</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> m [<span class="dt">Stmt</span>]</span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a>readStmts path <span class="ot">=</span> liftIO <span class="op">$</span> input (list stmt) (T.pack path)</span></code></pre></div>
</div>
</section>
<section id="function-transformers" class="level3">
<h3>Function transformers</h3>
<div class="named-code-block">
<p>«milkshake-convenience»</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode dhall"><code class="sourceCode dhall"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> fileName <span class="fu">=</span> \(a <span class="fu">:</span> <span class="dt">Target</span>) <span class="ot">-&gt;</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">merge</span> { <span class="dt">File</span> <span class="fu">=</span> \(x <span class="fu">:</span> <span class="dt">Text</span>) <span class="ot">-&gt;</span> <span class="dt">Some</span> x</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>          , <span class="dt">Generic</span> <span class="fu">=</span> \(_ <span class="fu">:</span> <span class="dt">Virtual</span>) <span class="ot">-&gt;</span> <span class="dt">None</span> <span class="dt">Text</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>          , <span class="dt">Phony</span> <span class="fu">=</span>   \(_ <span class="fu">:</span> <span class="dt">Text</span>) <span class="ot">-&gt;</span> <span class="dt">None</span> <span class="dt">Text</span> } a</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="dt">Target</span><span class="fu">/</span>isFile <span class="fu">=</span> \(a <span class="fu">:</span> <span class="dt">Target</span>) <span class="ot">-&gt;</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">merge</span> { <span class="dt">File</span> <span class="fu">=</span> \(_ <span class="fu">:</span> <span class="dt">Text</span>) <span class="ot">-&gt;</span> <span class="dt">True</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>          , <span class="dt">Generic</span> <span class="fu">=</span> \(_ <span class="fu">:</span> <span class="dt">Virtual</span>) <span class="ot">-&gt;</span> <span class="dt">False</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>          , <span class="dt">Phony</span> <span class="fu">=</span> \(_ <span class="fu">:</span> <span class="dt">Text</span>) <span class="ot">-&gt;</span> <span class="dt">False</span> } a</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> getFiles <span class="fu">=</span> \(a <span class="fu">:</span> <span class="dt">List</span> <span class="dt">Target</span>) <span class="ot">-&gt;</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>    Prelude.List.unpackOptionals <span class="dt">Text</span> (<span class="dt">List</span><span class="fu">/</span>map <span class="dt">Target</span> (<span class="dt">Optional</span> <span class="dt">Text</span>) fileName a)</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> testGetFiles <span class="fu">=</span> <span class="kw">assert</span> <span class="fu">:</span> getFiles [ <span class="dt">Target.File</span> <span class="st">&quot;a&quot;</span>, <span class="dt">Target.Phony</span> <span class="st">&quot;m&quot;</span>, <span class="dt">Target.File</span> <span class="st">&quot;b&quot;</span> ]</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">===</span> [ <span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>]</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> fileRule <span class="fu">=</span> \(name <span class="fu">:</span> <span class="dt">Text</span>) <span class="ot">-&gt;</span> \(f <span class="fu">:</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">List</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Text</span>) <span class="ot">-&gt;</span></span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>     rule name (\(tgt <span class="fu">:</span> <span class="dt">List</span> <span class="dt">Target</span>) <span class="ot">-&gt;</span> \(dep <span class="fu">:</span> <span class="dt">List</span> <span class="dt">Target</span>) <span class="ot">-&gt;</span></span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">merge</span> { <span class="dt">Some</span> <span class="fu">=</span> \(inp <span class="fu">:</span> <span class="dt">Text</span>) <span class="ot">-&gt;</span> <span class="dt">Some</span> (f inp (getFiles dep))</span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>            , <span class="dt">None</span> <span class="fu">=</span> <span class="dt">None</span> <span class="dt">Text</span> } (<span class="dt">List</span><span class="fu">/</span>head <span class="dt">Text</span> (getFiles tgt)))</span></code></pre></div>
</div>
<div class="named-code-block">
<p>«milkshake-convenience»</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode dhall"><code class="sourceCode dhall"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> fileAction <span class="fu">=</span> \(target <span class="fu">:</span> <span class="dt">Text</span>) <span class="ot">-&gt;</span> \(deps <span class="fu">:</span> <span class="dt">List</span> <span class="dt">Text</span>) <span class="ot">-&gt;</span> \(script <span class="fu">:</span> <span class="dt">Text</span>) <span class="ot">-&gt;</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Stmt.Action</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>        { target <span class="fu">=</span> [ <span class="dt">Target.File</span> target ]</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>        , dependency <span class="fu">=</span> <span class="dt">List</span><span class="fu">/</span>map <span class="dt">Text</span> <span class="dt">Target</span> <span class="dt">Target.File</span> deps</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>        , script <span class="fu">=</span> <span class="dt">Some</span> script }</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> fileCall <span class="fu">=</span> \(name <span class="fu">:</span> <span class="dt">Text</span>) <span class="ot">-&gt;</span> \(tgt <span class="fu">:</span> <span class="dt">Text</span>) <span class="ot">-&gt;</span> \(deps <span class="fu">:</span> <span class="dt">List</span> <span class="dt">Text</span>) <span class="ot">-&gt;</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>    call name [<span class="dt">Target.File</span> tgt] (<span class="dt">List</span><span class="fu">/</span>map <span class="dt">Text</span> <span class="dt">Target</span> <span class="dt">Target.File</span> deps)</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> mainAction <span class="fu">=</span> \(deps <span class="fu">:</span> <span class="dt">List</span> <span class="dt">Text</span>) <span class="ot">-&gt;</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Stmt.Action</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>        { target <span class="fu">=</span> [ <span class="dt">Target.Phony</span> <span class="st">&quot;main&quot;</span> ]</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>        , dependency <span class="fu">=</span> <span class="dt">List</span><span class="fu">/</span>map <span class="dt">Text</span> <span class="dt">Target</span> <span class="dt">Target.File</span> deps</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>        , script <span class="fu">=</span> <span class="dt">None</span> <span class="dt">Text</span> }</span></code></pre></div>
</div>
</section>
<section id="schema" class="level3">
<h3>Schema</h3>
<div class="named-code-block">
<p>file:test/Layer2/schema.dhall</p>
<pre class="dhall"><code>let Prelude = https://prelude.dhall-lang.org/v19.0.0/package.dhall
    sha256:eb693342eb769f782174157eba9b5924cf8ac6793897fc36a31ccbd6f56dafe2
let List/map = Prelude.List.map
let Text/concatSep = Prelude.Text.concatSep
let Map/Type = Prelude.Map.Type
let Map/Entry = Prelude.Map.Entry
-- let List/map = https://prelude.dhall-lang.org/v11.1.0/List/map
--     sha256:dd845ffb4568d40327f2a817eb42d1c6138b929ca758d50bc33112ef3c885680
-- let List/unpackOptionals = https://prelude.dhall-lang.org/v11.1.0/List/unpackOptionals
--     sha256:0cbaa920f429cf7fc3907f8a9143203fe948883913560e6e1043223e6b3d05e4

&lt;&lt;milkshake-target&gt;&gt;
&lt;&lt;milkshake-action&gt;&gt;
&lt;&lt;milkshake-trigger&gt;&gt;
&lt;&lt;milkshake-rule&gt;&gt;
&lt;&lt;milkshake-stmt&gt;&gt;
&lt;&lt;milkshake-convenience&gt;&gt;

in  { Stmt = Stmt
    , Target = Target, action = action, rule = rule, call = call
    , include = include, main = main
    , fileName = fileName
    , getFiles = getFiles
    , fileRule = fileRule
    , fileAction = fileAction
    , mainAction = mainAction
    }</code></pre>
</div>
</section>
<section id="example-3-compiling-c-in-two-steps" class="level3">
<h3>Example 3: compiling C in two steps</h3>
<div class="named-code-block">
<p>file:test/Layer2/test2.dhall</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode dhall"><code class="sourceCode dhall"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="dt">Text</span><span class="fu">/</span>concatSep <span class="fu">=</span> https<span class="fu">://</span>prelude<span class="fu">.</span>dhall<span class="fu">-</span>lang<span class="fu">.</span>org<span class="fu">/</span><span class="dt">Text</span><span class="fu">/</span>concatSep</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    sha256<span class="fu">:</span>e4401d69918c61b92a4c0288f7d60a6560ca99726138ed8ebc58dca2cd205e58</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> ms <span class="fu">=</span> <span class="fu">./</span>schema<span class="fu">.</span>dhall</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="kw">in</span>  [ ms<span class="fu">.</span>fileRule <span class="st">&quot;compile&quot;</span> (\(tgt <span class="fu">:</span> <span class="dt">Text</span>) <span class="ot">-&gt;</span> \(deps <span class="fu">:</span> <span class="dt">List</span> <span class="dt">Text</span>) <span class="ot">-&gt;</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;&#39;</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a><span class="st">        gcc -c ${Text/concatSep &quot; &quot; deps} -o ${tgt}</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a><span class="st">        &#39;&#39;</span>)</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>    , ms<span class="fu">.</span>fileRule <span class="st">&quot;link&quot;</span> (\(tgt <span class="fu">:</span> <span class="dt">Text</span>) <span class="ot">-&gt;</span> \(deps <span class="fu">:</span> <span class="dt">List</span> <span class="dt">Text</span>) <span class="ot">-&gt;</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;&#39;</span></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a><span class="st">        gcc ${Text/concatSep &quot; &quot; deps} -o ${tgt}</span></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a><span class="st">        &#39;&#39;</span>)</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>    , ms<span class="fu">.</span>call <span class="st">&quot;compile&quot;</span></span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>        [ ms<span class="fu">.</span><span class="dt">Target.File</span> <span class="st">&quot;hello.o&quot;</span> ]</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>        [ ms<span class="fu">.</span><span class="dt">Target.File</span> <span class="st">&quot;hello.c&quot;</span> ]</span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>    , ms<span class="fu">.</span>call <span class="st">&quot;link&quot;</span></span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>        [ ms<span class="fu">.</span><span class="dt">Target.File</span> <span class="st">&quot;hello&quot;</span> ]</span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>        [ ms<span class="fu">.</span><span class="dt">Target.File</span> <span class="st">&quot;hello.o&quot;</span> ]</span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>    , ms<span class="fu">.</span>fileAction <span class="st">&quot;out.txt&quot;</span> [ <span class="st">&quot;hello&quot;</span> ]</span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;&#39;</span></span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a><span class="st">        ./hello &gt; out.txt</span></span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a><span class="st">        &#39;&#39;</span></span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a>    , ms<span class="fu">.</span>mainAction [ <span class="st">&quot;out.txt&quot;</span> ]</span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a>    ] <span class="fu">:</span> <span class="dt">List</span> ms<span class="fu">.</span><span class="dt">Stmt</span></span></code></pre></div>
</div>
<div class="named-code-block">
<p>«haskell-types»</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co">{-| Transposed data record of a list of `Stmt`. -}</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Config</span> <span class="ot">=</span> <span class="dt">Config</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    {<span class="ot"> rules      ::</span> <span class="dt">M.Map</span> <span class="dt">Text</span> <span class="dt">Generator</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    ,<span class="ot"> triggers   ::</span> [<span class="dt">Call</span>]</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>    ,<span class="ot"> actions    ::</span> [<span class="dt">Action</span>]</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>    ,<span class="ot"> includes   ::</span> [<span class="dt">FilePath</span>]</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>    ,<span class="ot"> mainTarget ::</span> [<span class="dt">FilePath</span>]</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>    ,<span class="ot"> watches    ::</span> [<span class="dt">Watch</span>] }</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">deriving</span> (<span class="dt">Generic</span>)</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">deriving</span> <span class="dt">Semigroup</span> via <span class="dt">GenericSemigroup</span> <span class="dt">Config</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">deriving</span> <span class="dt">Monoid</span>    via <span class="dt">GenericMonoid</span> <span class="dt">Config</span></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a><span class="co">{-| Groups a list of &#39;Stmt&#39; into a &#39;Config&#39; record. -}</span></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a><span class="ot">stmtsToConfig ::</span> [<span class="dt">Stmt</span>] <span class="ot">-&gt;</span> <span class="dt">Config</span></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>stmtsToConfig <span class="ot">=</span> <span class="fu">foldMap</span> toConfig</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">where</span> toConfig (<span class="dt">StmtAction</span> a) <span class="ot">=</span> <span class="fu">mempty</span> { actions <span class="ot">=</span> [a] }</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>          toConfig (<span class="dt">StmtRule</span> <span class="dt">Rule</span> {<span class="op">..</span>})   <span class="ot">=</span> <span class="fu">mempty</span> { rules <span class="ot">=</span> M.singleton name gen }</span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>          toConfig (<span class="dt">StmtCall</span> t) <span class="ot">=</span> <span class="fu">mempty</span> { triggers <span class="ot">=</span> [t] }</span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>          toConfig (<span class="dt">StmtInclude</span> i) <span class="ot">=</span> <span class="fu">mempty</span> { includes <span class="ot">=</span> [i] }</span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>          toConfig (<span class="dt">StmtMain</span> m) <span class="ot">=</span> <span class="fu">mempty</span> { mainTarget <span class="ot">=</span> m }</span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>          toConfig (<span class="dt">StmtWatch</span> w) <span class="ot">=</span> <span class="fu">mempty</span> { watches <span class="ot">=</span> [w] }</span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a><span class="co">{-| Read a script directly to `Config` record. -}</span></span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a><span class="ot">readConfig ::</span> (<span class="dt">MonadIO</span> m) <span class="ot">=&gt;</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> m <span class="dt">Config</span></span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a>readConfig f <span class="ot">=</span> stmtsToConfig <span class="op">&lt;$&gt;</span> readStmts f</span></code></pre></div>
</div>
<div class="named-code-block">
<p>file:test/Layer2Spec.hs</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE NoImplicitPrelude,DuplicateRecordFields,OverloadedLabels #-}</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">Layer2Spec</span> (spec) <span class="kw">where</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">RIO</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="co">-- import qualified RIO.Text as T</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Test.Hspec</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Milkshake.Data</span> (<span class="dt">Action</span>(..), <span class="dt">Target</span>(..), readStmts, <span class="dt">Config</span>(..), stmtsToConfig)</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Milkshake.Run</span> (enter, fromCall)</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Development.Shake</span> (shake, shakeOptions)</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Util</span> (runInTmp)</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a><span class="ot">spec ::</span> <span class="dt">Spec</span></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>spec <span class="ot">=</span> describe <span class="st">&quot;Layer2&quot;</span> <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>    it <span class="st">&quot;can load a configuration&quot;</span> <span class="op">$</span> runInTmp [<span class="st">&quot;./test/Layer2/*&quot;</span>] <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>        cfg <span class="ot">&lt;-</span> stmtsToConfig <span class="op">&lt;$&gt;</span> readStmts <span class="st">&quot;./test2.dhall&quot;</span></span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>        (actions cfg) <span class="ot">`shouldSatisfy`</span> <span class="fu">any</span> (\<span class="dt">Action</span>{<span class="op">..</span>} <span class="ot">-&gt;</span> target <span class="op">==</span> [<span class="dt">Phony</span> <span class="st">&quot;main&quot;</span>])</span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>    it <span class="st">&quot;can run all actions&quot;</span> <span class="op">$</span> runInTmp [<span class="st">&quot;./test/Layer1/hello.c&quot;</span>, <span class="st">&quot;./test/Layer2/*&quot;</span>] <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>        cfg <span class="ot">&lt;-</span> stmtsToConfig <span class="op">&lt;$&gt;</span> readStmts <span class="st">&quot;./test2.dhall&quot;</span></span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>        (actions cfg) <span class="ot">`shouldSatisfy`</span> <span class="fu">any</span> (\<span class="dt">Action</span>{<span class="op">..</span>} <span class="ot">-&gt;</span> target <span class="op">==</span> [<span class="dt">Phony</span> <span class="st">&quot;main&quot;</span>])</span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">case</span> <span class="fu">mapM</span> (fromCall cfg) (triggers cfg) <span class="kw">of</span></span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Left</span> e <span class="ot">-&gt;</span> throwM e</span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Right</span> as <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> actionList <span class="ot">=</span> (actions cfg) <span class="op">&lt;&gt;</span> as</span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a>                shake shakeOptions (<span class="fu">mapM_</span> enter actionList)</span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a>                result <span class="ot">&lt;-</span> readFileUtf8 <span class="st">&quot;out.txt&quot;</span></span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a>                result <span class="ot">`shouldBe`</span> <span class="st">&quot;Hello, World!\n&quot;</span></span></code></pre></div>
</div>
</section>
</section>
<section id="third-layer-the-scan" class="level2">
<h2>Third Layer: the scan</h2>
<p>Now that we have separated actions into rules and triggers, we can imagine a user defining a set of rules, and a situation, script, workflow needing/generating a set of triggers for us. In the case of compiling a C program, the scan would list the dependencies of an object file as being the related source file and headers (retrieved with <code>gcc -MM</code>). In the case of Entangled we get a list of target files that depend on being tangled from a list of markdown source files.</p>
<p>The trick is to make this scan part of the workflow of actions. In C terms, <code>gcc -MM hello.c</code> depends on <code>hello.c</code>. We need to recognize the fact that the output of <code>gcc -MM</code> serves as input for more actions. In the most generic sense, we can imagine <code>gcc -M</code> also knowing the name of the rule it is providing the dependency relations for.</p>
<p>We define <code>includes</code> to be a list of <code>Target</code>. Each item may be a literal include file or be associated with a rule.</p>
<section id="example-4-generated-include" class="level3">
<h3>Example 4: generated include</h3>
<p>The schema doesn’t change.</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode {.dhall"><code class="sourceCode dhall"></code></pre></div>
<p>We have one template that generates an action.</p>
<div class="named-code-block">
<p>file:test/Layer3/template.dhall</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode dhall"><code class="sourceCode dhall"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> ms <span class="fu">=</span> <span class="fu">./</span>schema<span class="fu">.</span>dhall</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="kw">in</span> \(x <span class="fu">:</span> <span class="dt">Natural</span>) <span class="ot">-&gt;</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>    [ ms<span class="fu">.</span>fileAction <span class="st">&quot;answer.txt&quot;</span> ([] <span class="fu">:</span> <span class="dt">List</span> <span class="dt">Text</span>)</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;&#39;</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="st">        echo &quot;${Natural/show x}&quot; &gt; answer.txt</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="st">        &#39;&#39;</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>    ]</span></code></pre></div>
</div>
<p>The main file imports the generated include</p>
<div class="named-code-block">
<p>file:test/Layer3/test1.dhall</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode dhall"><code class="sourceCode dhall"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> ms <span class="fu">=</span> <span class="fu">./</span>schema<span class="fu">.</span>dhall</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="kw">in</span>  [ ms<span class="fu">.</span>fileAction <span class="st">&quot;include.dhall&quot;</span> ([] <span class="fu">:</span> <span class="dt">List</span> <span class="dt">Text</span>)</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;&#39;</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="st">        echo &quot;./template.dhall 42&quot; | dhall &gt; include.dhall</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="st">        &#39;&#39;</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>    , ms<span class="fu">.</span>include <span class="st">&quot;include.dhall&quot;</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>    , ms<span class="fu">.</span>main [<span class="st">&quot;answer.txt&quot;</span>]</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>    ]</span></code></pre></div>
</div>
</section>
<section id="the-recursion" class="level3">
<h3>The recursion</h3>
<div class="named-code-block">
<p>file:test/Layer3Spec.hs</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE NoImplicitPrelude,DuplicateRecordFields,OverloadedLabels #-}</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">Layer3Spec</span> (spec) <span class="kw">where</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">RIO</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Test.Hspec</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Milkshake.Data</span> (readStmts, <span class="dt">Config</span>(..), stmtsToConfig)</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Milkshake.Run</span> (enter, loadIncludes, immediateActions)</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Development.Shake</span> (shake, shakeOptions, want)</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Util</span> (runInTmp)</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a><span class="ot">spec ::</span> <span class="dt">Spec</span></span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>spec <span class="ot">=</span> describe <span class="st">&quot;Layer3&quot;</span> <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>    it <span class="st">&quot;can load a configuration&quot;</span> <span class="op">$</span> runInTmp [<span class="st">&quot;./test/Layer3/*&quot;</span>] <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>        cfg <span class="ot">&lt;-</span> stmtsToConfig <span class="op">&lt;$&gt;</span> readStmts <span class="st">&quot;./test1.dhall&quot;</span></span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>        mainTarget cfg <span class="ot">`shouldSatisfy`</span> (<span class="fu">not</span> <span class="op">.</span> <span class="fu">null</span>)</span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>        gen <span class="ot">&lt;-</span> stmtsToConfig <span class="op">&lt;$&gt;</span> readStmts <span class="st">&quot;./template.dhall 42&quot;</span></span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a>        actions gen <span class="ot">`shouldSatisfy`</span> (<span class="fu">not</span> <span class="op">.</span> <span class="fu">null</span>)</span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a>    it <span class="st">&quot;can run all actions&quot;</span> <span class="op">$</span> runInTmp [<span class="st">&quot;./test/Layer3/*&quot;</span>] <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a>        cfg <span class="ot">&lt;-</span> loadIncludes <span class="op">.</span> stmtsToConfig <span class="op">=&lt;&lt;</span> readStmts <span class="st">&quot;./test1.dhall&quot;</span></span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a>        actions <span class="ot">&lt;-</span> <span class="fu">either</span> throwM <span class="fu">return</span> <span class="op">$</span> immediateActions cfg</span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a>        shake shakeOptions (<span class="fu">mapM_</span> enter actions <span class="op">&gt;&gt;</span> want (mainTarget cfg))</span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a>        result <span class="ot">&lt;-</span> readFileUtf8 <span class="st">&quot;answer.txt&quot;</span></span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a>        result <span class="ot">`shouldBe`</span> <span class="st">&quot;42\n&quot;</span></span></code></pre></div>
</div>
<div class="named-code-block">
<p>file:src/Milkshake/Run.hs</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co">{-| Given a `Config` and a `Call`, creates an `Action`. -}</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="ot">fromCall ::</span> <span class="dt">Config</span> <span class="ot">-&gt;</span> <span class="dt">Call</span> <span class="ot">-&gt;</span> <span class="dt">Either</span> <span class="dt">MilkshakeError</span> <span class="dt">Action</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>fromCall cfg <span class="dt">Call</span>{<span class="op">..</span>} <span class="ot">=</span> <span class="kw">case</span> rule <span class="kw">of</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Just</span> r  <span class="ot">-&gt;</span> <span class="dt">Right</span> <span class="op">$</span> <span class="dt">Action</span> target dependency (r target dependency)</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="dt">Left</span> <span class="op">$</span> <span class="dt">ConfigError</span> <span class="op">$</span> <span class="st">&quot;No such rule: &quot;</span> <span class="op">&lt;&gt;</span> name</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">where</span> rule <span class="ot">=</span> rules cfg <span class="op">M.!?</span> name</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a><span class="co">{-| Looks for actions that are immediately runnable. These are the plain</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a><span class="co">  `Action` statements, as well as calls to rules. The calls are expanded</span></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a><span class="co">  into actions, and a list of all actions is returned. -}</span></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a><span class="ot">immediateActions ::</span> <span class="dt">Config</span> <span class="ot">-&gt;</span> <span class="dt">Either</span> <span class="dt">MilkshakeError</span> [<span class="dt">Action</span>]</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>immediateActions cfg<span class="op">@</span><span class="dt">Config</span>{<span class="op">..</span>} <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>    triggered <span class="ot">&lt;-</span> <span class="fu">mapM</span> (fromCall cfg) triggers</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span> <span class="op">$</span> actions <span class="op">&lt;&gt;</span> triggered</span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a><span class="co">{-| Recursively loads include statements, until no includes are left. -}</span></span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a><span class="ot">loadIncludes ::</span> (<span class="dt">MonadThrow</span> m, <span class="dt">MonadIO</span> m) <span class="ot">=&gt;</span> <span class="dt">Config</span> <span class="ot">-&gt;</span> m <span class="dt">Config</span></span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>loadIncludes cfg<span class="op">@</span><span class="dt">Config</span>{includes<span class="ot">=</span>[]} <span class="ot">=</span> <span class="fu">return</span> cfg</span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a>loadIncludes cfg<span class="op">@</span><span class="dt">Config</span>{includes} <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a>    actions <span class="ot">&lt;-</span> <span class="fu">either</span> throwM <span class="fu">return</span> <span class="op">$</span> immediateActions cfg</span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a>    liftIO <span class="op">$</span> shake shakeOptions (<span class="fu">mapM_</span> enter actions <span class="op">&gt;&gt;</span> Shake.want includes)</span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a>    stmts <span class="ot">&lt;-</span> foldMapM readStmts (<span class="fu">map</span> (<span class="st">&quot;./&quot;</span> <span class="op">&lt;&gt;</span>) includes)</span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a>    loadIncludes <span class="op">$</span> cfg {includes <span class="ot">=</span> <span class="fu">mempty</span>} <span class="op">&lt;&gt;</span> stmtsToConfig stmts</span></code></pre></div>
</div>
</section>
</section>
<section id="file-event-loop" class="level2">
<h2>File event loop</h2>
<p>We want to be informed about file system events.</p>
<div class="named-code-block">
<p>file:src/Milkshake/Monitor.hs</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE MultiParamTypeClasses #-}</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="co">{-|</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="co">This module contains functionality that involves the interface with FSNotify.</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="co">The only important function here is `monitor`, next to some reexports from FSNotify.</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="co"> -}</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">Milkshake.Monitor</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>    ( monitor, <span class="dt">GlobList</span>, <span class="dt">FileEventHandler</span>, <span class="dt">Watch</span>, <span class="dt">StopListening</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>    , withWatchManager, <span class="dt">Event</span>(<span class="op">..</span>), eventPath</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>    , <span class="dt">WatchManager</span>, <span class="dt">HasWatchManager</span>(<span class="op">..</span>), <span class="dt">HasEventChannel</span>(<span class="op">..</span>) ) <span class="kw">where</span></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">RIO</span></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">RIO.List</span> (nub)</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">RIO.FilePath</span> (takeDirectory)</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">RIO.Directory</span> (canonicalizePath, doesDirectoryExist)</span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">RIO.Text</span> <span class="kw">as</span> <span class="dt">T</span></span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">System.FilePath.Glob</span> (glob)</span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">System.FSNotify</span> (withManager, <span class="dt">WatchManager</span>, <span class="dt">Event</span>(..), watchDir, eventPath)</span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a><span class="co">{-| File paths are expanded with `System.FilePath.Glob`. Input to `Watch` functionality,</span></span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a><span class="co">  i.e. a list of file patterns should follow this type. -}</span></span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">GlobList</span> <span class="ot">=</span> [<span class="dt">Text</span>]</span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a><span class="co">{-| An event handler, taking an `System.FSNotify.Event` and returning some internal</span></span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a><span class="co">  message type. -}</span></span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">FileEventHandler</span> m event <span class="ot">=</span> <span class="dt">Event</span> <span class="ot">-&gt;</span> m event</span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a><span class="co">{-| A `Watch` is a list of file patterns to watch and a corresponding `FileEventHandler`</span></span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a><span class="co"> -}</span></span>
<span id="cb52-28"><a href="#cb52-28" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">Watch</span> m event <span class="ot">=</span> (<span class="dt">GlobList</span>, <span class="dt">FileEventHandler</span> m event)</span>
<span id="cb52-29"><a href="#cb52-29" aria-hidden="true" tabindex="-1"></a><span class="co">{-| Every time we set a watch, we are given a function that, when called, unsets the</span></span>
<span id="cb52-30"><a href="#cb52-30" aria-hidden="true" tabindex="-1"></a><span class="co">    watch. -}</span></span>
<span id="cb52-31"><a href="#cb52-31" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">StopListening</span> m <span class="ot">=</span> m ()</span>
<span id="cb52-32"><a href="#cb52-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-33"><a href="#cb52-33" aria-hidden="true" tabindex="-1"></a><span class="co">{-| RIO class for obtaining the `System.FSNotify.WatchManager`.</span></span>
<span id="cb52-34"><a href="#cb52-34" aria-hidden="true" tabindex="-1"></a><span class="co"> -}</span></span>
<span id="cb52-35"><a href="#cb52-35" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> <span class="dt">HasWatchManager</span> env <span class="kw">where</span></span>
<span id="cb52-36"><a href="#cb52-36" aria-hidden="true" tabindex="-1"></a><span class="ot">    watchManager ::</span> <span class="dt">Lens&#39;</span> env <span class="dt">WatchManager</span></span>
<span id="cb52-37"><a href="#cb52-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-38"><a href="#cb52-38" aria-hidden="true" tabindex="-1"></a><span class="co">{-| RIO class for obtaining the event channel to which event messages are pushed.</span></span>
<span id="cb52-39"><a href="#cb52-39" aria-hidden="true" tabindex="-1"></a><span class="co"> -}</span></span>
<span id="cb52-40"><a href="#cb52-40" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> <span class="dt">HasEventChannel</span> env event <span class="kw">where</span></span>
<span id="cb52-41"><a href="#cb52-41" aria-hidden="true" tabindex="-1"></a><span class="ot">    eventChannel ::</span> <span class="dt">Lens&#39;</span> env (<span class="dt">Chan</span> event)</span>
<span id="cb52-42"><a href="#cb52-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-43"><a href="#cb52-43" aria-hidden="true" tabindex="-1"></a><span class="co">{-| Unlifted version of &#39;System.FSNotify.withManager&#39;. -}</span></span>
<span id="cb52-44"><a href="#cb52-44" aria-hidden="true" tabindex="-1"></a><span class="ot">withWatchManager ::</span> <span class="dt">MonadUnliftIO</span> m <span class="ot">=&gt;</span> (<span class="dt">WatchManager</span> <span class="ot">-&gt;</span> m a) <span class="ot">-&gt;</span> m a</span>
<span id="cb52-45"><a href="#cb52-45" aria-hidden="true" tabindex="-1"></a>withWatchManager callback <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb52-46"><a href="#cb52-46" aria-hidden="true" tabindex="-1"></a>    withRunInIO (\run <span class="ot">-&gt;</span> liftIO <span class="op">$</span> withManager (run <span class="op">.</span> callback))</span>
<span id="cb52-47"><a href="#cb52-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-48"><a href="#cb52-48" aria-hidden="true" tabindex="-1"></a><span class="co">{-| Expand a glob string into all realised paths, and return a list with</span></span>
<span id="cb52-49"><a href="#cb52-49" aria-hidden="true" tabindex="-1"></a><span class="co">  unique containing directories. Those are the ones we set watches on.</span></span>
<span id="cb52-50"><a href="#cb52-50" aria-hidden="true" tabindex="-1"></a><span class="co">  -}</span></span>
<span id="cb52-51"><a href="#cb52-51" aria-hidden="true" tabindex="-1"></a><span class="ot">globCanon ::</span> <span class="dt">MonadIO</span> m <span class="ot">=&gt;</span> [<span class="dt">Text</span>] <span class="ot">-&gt;</span> m [<span class="dt">FilePath</span>]</span>
<span id="cb52-52"><a href="#cb52-52" aria-hidden="true" tabindex="-1"></a>globCanon globs <span class="ot">=</span> liftIO <span class="op">$</span> nub <span class="op">&lt;$&gt;</span> (search <span class="op">&gt;&gt;=</span> canonicalize)</span>
<span id="cb52-53"><a href="#cb52-53" aria-hidden="true" tabindex="-1"></a>    <span class="kw">where</span> search <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb52-54"><a href="#cb52-54" aria-hidden="true" tabindex="-1"></a>            files <span class="ot">&lt;-</span> <span class="fu">mconcat</span> <span class="op">&lt;$&gt;</span> <span class="fu">mapM</span> (glob <span class="op">.</span> T.unpack) globs</span>
<span id="cb52-55"><a href="#cb52-55" aria-hidden="true" tabindex="-1"></a>            parents <span class="ot">&lt;-</span> <span class="fu">mconcat</span> <span class="op">&lt;$&gt;</span> <span class="fu">mapM</span> (glob <span class="op">.</span> takeDirectory <span class="op">.</span> T.unpack) globs</span>
<span id="cb52-56"><a href="#cb52-56" aria-hidden="true" tabindex="-1"></a>            dirs <span class="ot">&lt;-</span> filterM doesDirectoryExist parents</span>
<span id="cb52-57"><a href="#cb52-57" aria-hidden="true" tabindex="-1"></a>            <span class="fu">return</span> <span class="op">$</span> dirs <span class="op">&lt;&gt;</span> <span class="fu">map</span> takeDirectory files</span>
<span id="cb52-58"><a href="#cb52-58" aria-hidden="true" tabindex="-1"></a>          canonicalize <span class="ot">=</span> <span class="fu">mapM</span> canonicalizePath</span>
<span id="cb52-59"><a href="#cb52-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-60"><a href="#cb52-60" aria-hidden="true" tabindex="-1"></a><span class="co">{-| Set a watch. -}</span></span>
<span id="cb52-61"><a href="#cb52-61" aria-hidden="true" tabindex="-1"></a><span class="ot">setWatch ::</span> (<span class="dt">MonadUnliftIO</span> m, <span class="dt">MonadReader</span> env m, <span class="dt">HasLogFunc</span> env)</span>
<span id="cb52-62"><a href="#cb52-62" aria-hidden="true" tabindex="-1"></a>         <span class="ot">=&gt;</span> <span class="dt">WatchManager</span> <span class="ot">-&gt;</span> <span class="dt">Chan</span> event </span>
<span id="cb52-63"><a href="#cb52-63" aria-hidden="true" tabindex="-1"></a>         <span class="ot">-&gt;</span> <span class="dt">Watch</span> m event <span class="ot">-&gt;</span> m (<span class="dt">StopListening</span> m)</span>
<span id="cb52-64"><a href="#cb52-64" aria-hidden="true" tabindex="-1"></a>setWatch wm chan (globs, handler) <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb52-65"><a href="#cb52-65" aria-hidden="true" tabindex="-1"></a>    dirList <span class="ot">&lt;-</span> globCanon globs</span>
<span id="cb52-66"><a href="#cb52-66" aria-hidden="true" tabindex="-1"></a>    logDebug <span class="op">$</span> display <span class="op">$</span> <span class="st">&quot;watching: &quot;</span> <span class="op">&lt;&gt;</span> tshow dirList</span>
<span id="cb52-67"><a href="#cb52-67" aria-hidden="true" tabindex="-1"></a>    stopActions <span class="ot">&lt;-</span> withRunInIO (\run <span class="ot">-&gt;</span></span>
<span id="cb52-68"><a href="#cb52-68" aria-hidden="true" tabindex="-1"></a>        liftIO <span class="op">$</span> <span class="fu">mapM</span></span>
<span id="cb52-69"><a href="#cb52-69" aria-hidden="true" tabindex="-1"></a>            (\dir <span class="ot">-&gt;</span> watchDir wm dir (<span class="fu">const</span> <span class="dt">True</span>)</span>
<span id="cb52-70"><a href="#cb52-70" aria-hidden="true" tabindex="-1"></a>                (\ev <span class="ot">-&gt;</span> run <span class="op">$</span> handler ev <span class="op">&gt;&gt;=</span> writeChan chan)) dirList)</span>
<span id="cb52-71"><a href="#cb52-71" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span> <span class="op">$</span> liftIO <span class="op">$</span> <span class="fu">sequence_</span> stopActions</span>
<span id="cb52-72"><a href="#cb52-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-73"><a href="#cb52-73" aria-hidden="true" tabindex="-1"></a><span class="co">{-| Starts a number of watches, where each watch is specified by a list of</span></span>
<span id="cb52-74"><a href="#cb52-74" aria-hidden="true" tabindex="-1"></a><span class="co">    glob-patterns and a handler that converts &#39;Event&#39; to a message. Generated</span></span>
<span id="cb52-75"><a href="#cb52-75" aria-hidden="true" tabindex="-1"></a><span class="co">    events are pushed to the given channel. Returns an IO action that will stop</span></span>
<span id="cb52-76"><a href="#cb52-76" aria-hidden="true" tabindex="-1"></a><span class="co">    all of these watches.</span></span>
<span id="cb52-77"><a href="#cb52-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-78"><a href="#cb52-78" aria-hidden="true" tabindex="-1"></a><span class="co">    The glob-pattern is expanded such that all directories containing matching</span></span>
<span id="cb52-79"><a href="#cb52-79" aria-hidden="true" tabindex="-1"></a><span class="co">    files are watched. In addition we also watch these directories if they&#39;re</span></span>
<span id="cb52-80"><a href="#cb52-80" aria-hidden="true" tabindex="-1"></a><span class="co">    empty, so that we trigger on file creation events. -}</span></span>
<span id="cb52-81"><a href="#cb52-81" aria-hidden="true" tabindex="-1"></a><span class="ot">monitor ::</span> ( <span class="dt">MonadUnliftIO</span> m, <span class="dt">MonadReader</span> env m, <span class="dt">HasLogFunc</span> env</span>
<span id="cb52-82"><a href="#cb52-82" aria-hidden="true" tabindex="-1"></a>           , <span class="dt">HasWatchManager</span> env, <span class="dt">HasEventChannel</span> env event )</span>
<span id="cb52-83"><a href="#cb52-83" aria-hidden="true" tabindex="-1"></a>        <span class="ot">=&gt;</span> [<span class="dt">Watch</span> m event] <span class="ot">-&gt;</span> m (<span class="dt">StopListening</span> m)</span>
<span id="cb52-84"><a href="#cb52-84" aria-hidden="true" tabindex="-1"></a>monitor watches <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb52-85"><a href="#cb52-85" aria-hidden="true" tabindex="-1"></a>    wm <span class="ot">&lt;-</span> view watchManager</span>
<span id="cb52-86"><a href="#cb52-86" aria-hidden="true" tabindex="-1"></a>    ch <span class="ot">&lt;-</span> view eventChannel</span>
<span id="cb52-87"><a href="#cb52-87" aria-hidden="true" tabindex="-1"></a>    stopActions <span class="ot">&lt;-</span> <span class="fu">mapM</span> (setWatch wm ch) watches</span>
<span id="cb52-88"><a href="#cb52-88" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span> <span class="op">$</span> <span class="fu">sequence_</span> stopActions</span></code></pre></div>
</div>
<div class="named-code-block">
<p>file:test/Milkshake/MonitorSpec.hs</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE MultiParamTypeClasses #-}</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">Milkshake.MonitorSpec</span> (spec) <span class="kw">where</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">RIO</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">RIO.Directory</span> (canonicalizePath)</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">RIO.File</span> (writeBinaryFile)</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Test.Hspec</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Util</span> (runInTmp)</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Milkshake.Monitor</span></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Env</span> <span class="ot">=</span> <span class="dt">Env</span></span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>    {<span class="ot"> _watchManager ::</span> <span class="dt">WatchManager</span></span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>    ,<span class="ot"> _channel      ::</span> <span class="dt">Chan</span> <span class="dt">Event</span></span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>    ,<span class="ot"> _logger       ::</span> <span class="dt">LogFunc</span></span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">HasWatchManager</span> <span class="dt">Env</span> <span class="kw">where</span></span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a>    watchManager <span class="ot">=</span> lens _watchManager (\e m <span class="ot">-&gt;</span> e { _watchManager <span class="ot">=</span> m })</span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">HasLogFunc</span> <span class="dt">Env</span> <span class="kw">where</span></span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a>    logFuncL <span class="ot">=</span> lens _logger (\e l <span class="ot">-&gt;</span> e { _logger <span class="ot">=</span> l })</span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">HasEventChannel</span> <span class="dt">Env</span> <span class="dt">Event</span> <span class="kw">where</span></span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a>    eventChannel <span class="ot">=</span> lens _channel (\e c <span class="ot">-&gt;</span> e { _channel <span class="ot">=</span> c })</span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a><span class="ot">runEnv ::</span> <span class="dt">MonadUnliftIO</span> m <span class="ot">=&gt;</span> <span class="dt">RIO</span> <span class="dt">Env</span> a <span class="ot">-&gt;</span> m a</span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a>runEnv action <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb53-30"><a href="#cb53-30" aria-hidden="true" tabindex="-1"></a>    logOptions <span class="ot">&lt;-</span> logOptionsHandle stderr <span class="dt">True</span></span>
<span id="cb53-31"><a href="#cb53-31" aria-hidden="true" tabindex="-1"></a>    withLogFunc logOptions (\logFunc <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb53-32"><a href="#cb53-32" aria-hidden="true" tabindex="-1"></a>        withWatchManager (\wm <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb53-33"><a href="#cb53-33" aria-hidden="true" tabindex="-1"></a>            ch <span class="ot">&lt;-</span> newChan</span>
<span id="cb53-34"><a href="#cb53-34" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> env <span class="ot">=</span> <span class="dt">Env</span> wm ch logFunc</span>
<span id="cb53-35"><a href="#cb53-35" aria-hidden="true" tabindex="-1"></a>            runRIO env action))</span>
<span id="cb53-36"><a href="#cb53-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-37"><a href="#cb53-37" aria-hidden="true" tabindex="-1"></a><span class="ot">spec ::</span> <span class="dt">Spec</span></span>
<span id="cb53-38"><a href="#cb53-38" aria-hidden="true" tabindex="-1"></a>spec <span class="ot">=</span> describe <span class="st">&quot;Monitor&quot;</span> <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb53-39"><a href="#cb53-39" aria-hidden="true" tabindex="-1"></a>    it <span class="st">&quot;monitors file creation&quot;</span> <span class="op">$</span> runInTmp [] <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb53-40"><a href="#cb53-40" aria-hidden="true" tabindex="-1"></a>        signal <span class="ot">&lt;-</span> runEnv <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb53-41"><a href="#cb53-41" aria-hidden="true" tabindex="-1"></a>                chan <span class="ot">&lt;-</span> view eventChannel</span>
<span id="cb53-42"><a href="#cb53-42" aria-hidden="true" tabindex="-1"></a>                stop <span class="ot">&lt;-</span> monitor [([<span class="st">&quot;./*&quot;</span>], <span class="fu">return</span>)]</span>
<span id="cb53-43"><a href="#cb53-43" aria-hidden="true" tabindex="-1"></a>                writeBinaryFile <span class="st">&quot;test.txt&quot;</span> <span class="fu">mempty</span></span>
<span id="cb53-44"><a href="#cb53-44" aria-hidden="true" tabindex="-1"></a>                signal <span class="ot">&lt;-</span> timeout <span class="dv">1000</span> <span class="op">$</span> readChan chan</span>
<span id="cb53-45"><a href="#cb53-45" aria-hidden="true" tabindex="-1"></a>                stop</span>
<span id="cb53-46"><a href="#cb53-46" aria-hidden="true" tabindex="-1"></a>                <span class="fu">return</span> signal</span>
<span id="cb53-47"><a href="#cb53-47" aria-hidden="true" tabindex="-1"></a>        abs_filename <span class="ot">&lt;-</span> canonicalizePath <span class="st">&quot;./test.txt&quot;</span></span>
<span id="cb53-48"><a href="#cb53-48" aria-hidden="true" tabindex="-1"></a>        signal <span class="ot">`shouldSatisfy`</span> \<span class="kw">case</span></span>
<span id="cb53-49"><a href="#cb53-49" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Just</span> (<span class="dt">Added</span> path _ _) <span class="ot">-&gt;</span> path <span class="op">==</span> abs_filename</span>
<span id="cb53-50"><a href="#cb53-50" aria-hidden="true" tabindex="-1"></a>            _                     <span class="ot">-&gt;</span> <span class="dt">False</span></span></code></pre></div>
</div>
</section>
<section id="adding-watches" class="level2">
<h2>Adding watches</h2>
<div class="named-code-block">
<p>«haskell-types»</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co">{-| A `Watch` is used to keep targets up-to-date when source files change.</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="co"> -}</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Watch</span> <span class="ot">=</span> <span class="dt">Watch</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    {<span class="ot"> paths ::</span> [<span class="dt">Text</span>]           <span class="co">-- ^ lists of paths to monitor</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>    ,<span class="ot"> target ::</span> <span class="dt">Target</span>          <span class="co">-- ^ target to build on file event</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>    } <span class="kw">deriving</span> (<span class="dt">Generic</span>)</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">FromDhall</span> <span class="dt">Watch</span></span></code></pre></div>
</div>
<div class="named-code-block">
<p>«stmt-type»</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="op">|</span> <span class="dt">StmtWatch</span> <span class="dt">Watch</span></span></code></pre></div>
</div>
<div class="named-code-block">
<p>«stmt-decoder»</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&gt;</span> (<span class="dt">StmtWatch</span>   <span class="op">&lt;$&gt;</span> constructor <span class="st">&quot;Watch&quot;</span> auto)</span></code></pre></div>
</div>
<div class="named-code-block">
<p>file:test/Layer4/schema.dhall</p>
<pre class="dhall"><code>let Prelude = https://prelude.dhall-lang.org/v19.0.0/package.dhall
    sha256:eb693342eb769f782174157eba9b5924cf8ac6793897fc36a31ccbd6f56dafe2
let List/map = Prelude.List.map
let Text/concatSep = Prelude.Text.concatSep
let Map/Type = Prelude.Map.Type
let Map/Entry = Prelude.Map.Entry
-- let List/map = https://prelude.dhall-lang.org/v11.1.0/List/map
--     sha256:dd845ffb4568d40327f2a817eb42d1c6138b929ca758d50bc33112ef3c885680
-- let List/unpackOptionals = https://prelude.dhall-lang.org/v11.1.0/List/unpackOptionals
--     sha256:0cbaa920f429cf7fc3907f8a9143203fe948883913560e6e1043223e6b3d05e4

&lt;&lt;milkshake-target&gt;&gt;
&lt;&lt;milkshake-action&gt;&gt;
&lt;&lt;milkshake-trigger&gt;&gt;
&lt;&lt;milkshake-rule&gt;&gt;
&lt;&lt;milkshake-stmt&gt;&gt;
&lt;&lt;milkshake-convenience&gt;&gt;

in  { Stmt = Stmt
    , Target = Target, action = action, rule = rule, call = call
    , include = include, main = main
    , fileName = fileName
    , getFiles = getFiles
    , fileRule = fileRule
    , fileAction = fileAction, fileCall = fileCall
    , mainAction = mainAction, watch = watch
    }</code></pre>
</div>
</section>
<section id="main-loop" class="level2">
<h2>Main loop</h2>
<div class="named-code-block">
<p>file:src/Milkshake.hs</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">Milkshake</span> ( <span class="dt">Config</span>(<span class="op">..</span>)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>                 , readConfig</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>                 , loadIncludes</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>                 , <span class="dt">WatchManager</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>                 , <span class="dt">Event</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>                 , monitor</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>                 , <span class="dt">HasWatchManager</span>(<span class="op">..</span>)</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>                 , <span class="dt">HasEventChannel</span>(<span class="op">..</span>)</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>                 , withWatchManager</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>                 , shake</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>                 , shakeOptions</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>                 , want</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>                 , enter</span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>                 , immediateActions</span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>                 ) <span class="kw">where</span></span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Milkshake.Data</span> ( readConfig, <span class="dt">Config</span>(..) )</span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Milkshake.Run</span> ( enter, loadIncludes, immediateActions )</span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Milkshake.Monitor</span> ( <span class="dt">WatchManager</span>, <span class="dt">Event</span>, monitor, <span class="dt">HasWatchManager</span>(..), <span class="dt">HasEventChannel</span>(..), withWatchManager )</span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Development.Shake</span> (shake, shakeOptions, want)</span></code></pre></div>
</div>
<div class="named-code-block">
<p>file:app/Main.hs</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">Main</span> <span class="kw">where</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">RIO</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">RIO.Text</span> <span class="kw">as</span> <span class="dt">T</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Options.Applicative</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Milkshake</span></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>    ( readConfig, loadIncludes, immediateActions, shake, shakeOptions, monitor, withWatchManager, want, enter</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>    , <span class="dt">HasWatchManager</span>, <span class="dt">HasEventChannel</span>(<span class="op">..</span>), <span class="dt">Config</span> )</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Milkshake</span> <span class="kw">as</span> <span class="dt">MS</span></span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Milkshake.Data</span> <span class="kw">as</span> <span class="dt">MS.Data</span></span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Args</span> <span class="ot">=</span> <span class="dt">Args</span></span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>    {<span class="ot"> inputFile ::</span> <span class="dt">FilePath</span></span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>    ,<span class="ot"> runOnce ::</span> <span class="dt">Bool</span> }</span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a><span class="ot">argParser ::</span> <span class="dt">ParserInfo</span> <span class="dt">Args</span></span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a>argParser <span class="ot">=</span> info (args <span class="op">&lt;**&gt;</span> helper)</span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a>              ( fullDesc</span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a>             <span class="op">&lt;&gt;</span> progDesc <span class="st">&quot;Build stuff on file system events.&quot;</span></span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true" tabindex="-1"></a>             <span class="op">&lt;&gt;</span> header <span class="st">&quot;milkshake - file system event loops&quot;</span> )</span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">where</span> args <span class="ot">=</span> <span class="dt">Args</span> <span class="op">&lt;$&gt;</span> argument str (metavar <span class="st">&quot;FILE&quot;</span> <span class="op">&lt;&gt;</span> help <span class="st">&quot;Input file&quot;</span>)</span>
<span id="cb59-22"><a href="#cb59-22" aria-hidden="true" tabindex="-1"></a>                      <span class="op">&lt;*&gt;</span> switch ( long <span class="st">&quot;once&quot;</span> <span class="op">&lt;&gt;</span> short <span class="ch">&#39;1&#39;</span> <span class="op">&lt;&gt;</span> help <span class="st">&quot;Run main target once&quot;</span> )</span>
<span id="cb59-23"><a href="#cb59-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-24"><a href="#cb59-24" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Env</span> <span class="ot">=</span> <span class="dt">Env</span></span>
<span id="cb59-25"><a href="#cb59-25" aria-hidden="true" tabindex="-1"></a>    {<span class="ot"> _watchManager ::</span> <span class="dt">MS.WatchManager</span></span>
<span id="cb59-26"><a href="#cb59-26" aria-hidden="true" tabindex="-1"></a>    ,<span class="ot"> _channel      ::</span> <span class="dt">Chan</span> <span class="dt">MS.Data.Target</span></span>
<span id="cb59-27"><a href="#cb59-27" aria-hidden="true" tabindex="-1"></a>    ,<span class="ot"> _logger       ::</span> <span class="dt">LogFunc</span></span>
<span id="cb59-28"><a href="#cb59-28" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb59-29"><a href="#cb59-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-30"><a href="#cb59-30" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">HasWatchManager</span> <span class="dt">Env</span> <span class="kw">where</span></span>
<span id="cb59-31"><a href="#cb59-31" aria-hidden="true" tabindex="-1"></a>    watchManager <span class="ot">=</span> lens _watchManager (\e m <span class="ot">-&gt;</span> e { _watchManager <span class="ot">=</span> m })</span>
<span id="cb59-32"><a href="#cb59-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-33"><a href="#cb59-33" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">HasLogFunc</span> <span class="dt">Env</span> <span class="kw">where</span></span>
<span id="cb59-34"><a href="#cb59-34" aria-hidden="true" tabindex="-1"></a>    logFuncL <span class="ot">=</span> lens _logger (\e l <span class="ot">-&gt;</span> e { _logger <span class="ot">=</span> l })</span>
<span id="cb59-35"><a href="#cb59-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-36"><a href="#cb59-36" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">HasEventChannel</span> <span class="dt">Env</span> <span class="dt">MS.Data.Target</span> <span class="kw">where</span></span>
<span id="cb59-37"><a href="#cb59-37" aria-hidden="true" tabindex="-1"></a>    eventChannel <span class="ot">=</span> lens _channel (\e c <span class="ot">-&gt;</span> e { _channel <span class="ot">=</span> c })</span>
<span id="cb59-38"><a href="#cb59-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-39"><a href="#cb59-39" aria-hidden="true" tabindex="-1"></a><span class="ot">runEnv ::</span> <span class="dt">MonadUnliftIO</span> m <span class="ot">=&gt;</span> <span class="dt">RIO</span> <span class="dt">Env</span> a <span class="ot">-&gt;</span> m a</span>
<span id="cb59-40"><a href="#cb59-40" aria-hidden="true" tabindex="-1"></a>runEnv x <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb59-41"><a href="#cb59-41" aria-hidden="true" tabindex="-1"></a>    logOptions <span class="ot">&lt;-</span> logOptionsHandle stderr <span class="dt">True</span></span>
<span id="cb59-42"><a href="#cb59-42" aria-hidden="true" tabindex="-1"></a>    withLogFunc logOptions (\logFunc <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb59-43"><a href="#cb59-43" aria-hidden="true" tabindex="-1"></a>        withWatchManager (\wm <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb59-44"><a href="#cb59-44" aria-hidden="true" tabindex="-1"></a>            ch <span class="ot">&lt;-</span> newChan</span>
<span id="cb59-45"><a href="#cb59-45" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> env <span class="ot">=</span> <span class="dt">Env</span> wm ch logFunc</span>
<span id="cb59-46"><a href="#cb59-46" aria-hidden="true" tabindex="-1"></a>            runRIO env x))</span>
<span id="cb59-47"><a href="#cb59-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-48"><a href="#cb59-48" aria-hidden="true" tabindex="-1"></a><span class="ot">runAction ::</span> <span class="dt">Config</span> <span class="ot">-&gt;</span> [<span class="dt">FilePath</span>] <span class="ot">-&gt;</span> <span class="dt">RIO</span> <span class="dt">Env</span> ()</span>
<span id="cb59-49"><a href="#cb59-49" aria-hidden="true" tabindex="-1"></a>runAction cfg tgts <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb59-50"><a href="#cb59-50" aria-hidden="true" tabindex="-1"></a>    actions <span class="ot">&lt;-</span> <span class="fu">either</span> throwM <span class="fu">return</span> <span class="op">$</span> immediateActions cfg</span>
<span id="cb59-51"><a href="#cb59-51" aria-hidden="true" tabindex="-1"></a>    liftIO <span class="op">$</span> shake shakeOptions (<span class="fu">mapM_</span> enter actions <span class="op">&gt;&gt;</span> want tgts)</span>
<span id="cb59-52"><a href="#cb59-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-53"><a href="#cb59-53" aria-hidden="true" tabindex="-1"></a><span class="ot">mainLoop ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">RIO</span> <span class="dt">Env</span> ()</span>
<span id="cb59-54"><a href="#cb59-54" aria-hidden="true" tabindex="-1"></a>mainLoop path <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb59-55"><a href="#cb59-55" aria-hidden="true" tabindex="-1"></a>    cfg <span class="ot">&lt;-</span> loadIncludes <span class="op">=&lt;&lt;</span> readConfig path</span>
<span id="cb59-56"><a href="#cb59-56" aria-hidden="true" tabindex="-1"></a>    chan <span class="ot">&lt;-</span> view eventChannel</span>
<span id="cb59-57"><a href="#cb59-57" aria-hidden="true" tabindex="-1"></a>    stop <span class="ot">&lt;-</span> monitor <span class="op">$</span> <span class="fu">map</span> (\<span class="dt">MS.Data.Watch</span>{<span class="op">..</span>} <span class="ot">-&gt;</span> (paths, \_ <span class="ot">-&gt;</span> <span class="fu">return</span> target)) (MS.Data.watches cfg)</span>
<span id="cb59-58"><a href="#cb59-58" aria-hidden="true" tabindex="-1"></a>    target <span class="ot">&lt;-</span> readChan chan</span>
<span id="cb59-59"><a href="#cb59-59" aria-hidden="true" tabindex="-1"></a>    stop</span>
<span id="cb59-60"><a href="#cb59-60" aria-hidden="true" tabindex="-1"></a>    <span class="kw">case</span> target <span class="kw">of</span></span>
<span id="cb59-61"><a href="#cb59-61" aria-hidden="true" tabindex="-1"></a>        (<span class="dt">MS.Data.File</span> path) <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb59-62"><a href="#cb59-62" aria-hidden="true" tabindex="-1"></a>            logDebug <span class="op">$</span> <span class="st">&quot;building &quot;</span> <span class="op">&lt;&gt;</span> display path</span>
<span id="cb59-63"><a href="#cb59-63" aria-hidden="true" tabindex="-1"></a>            runAction cfg [T.unpack path]</span>
<span id="cb59-64"><a href="#cb59-64" aria-hidden="true" tabindex="-1"></a>        _           <span class="ot">-&gt;</span> <span class="fu">return</span> ()</span>
<span id="cb59-65"><a href="#cb59-65" aria-hidden="true" tabindex="-1"></a>    mainLoop path</span>
<span id="cb59-66"><a href="#cb59-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-67"><a href="#cb59-67" aria-hidden="true" tabindex="-1"></a><span class="ot">runMain ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">RIO</span> <span class="dt">Env</span> ()</span>
<span id="cb59-68"><a href="#cb59-68" aria-hidden="true" tabindex="-1"></a>runMain path <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb59-69"><a href="#cb59-69" aria-hidden="true" tabindex="-1"></a>    cfg <span class="ot">&lt;-</span> loadIncludes <span class="op">=&lt;&lt;</span> readConfig path</span>
<span id="cb59-70"><a href="#cb59-70" aria-hidden="true" tabindex="-1"></a>    runAction cfg []</span>
<span id="cb59-71"><a href="#cb59-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-72"><a href="#cb59-72" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb59-73"><a href="#cb59-73" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb59-74"><a href="#cb59-74" aria-hidden="true" tabindex="-1"></a>    args <span class="ot">&lt;-</span> execParser argParser</span>
<span id="cb59-75"><a href="#cb59-75" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> path <span class="ot">=</span> inputFile args</span>
<span id="cb59-76"><a href="#cb59-76" aria-hidden="true" tabindex="-1"></a>    runEnv <span class="op">$</span> <span class="kw">if</span> (runOnce args) <span class="kw">then</span> runMain path <span class="kw">else</span> mainLoop path </span></code></pre></div>
</div>
</section>
</section>
        </div>
         <div class="col-3 col-s-3 menu" id="menu-container">
                <div id="menu"><nav id="TOC" role="doc-toc">
                                <ul>
                                <li><a href="#milkshake">Milkshake</a>
                                <ul>
                                <li><a href="#references">References</a></li>
                                </ul></li>
                                <li><a href="#tutorial">Tutorial</a>
                                <ul>
                                <li><a href="#rules">Rules</a></li>
                                <li><a href="#includes">Includes</a></li>
                                <li><a href="#watches">Watches</a></li>
                                </ul></li>
                                <li><a href="#milkshake-1">Milkshake</a>
                                <ul>
                                <li><a href="#cases--persona">Cases / Persona</a></li>
                                <li><a href="#a-minimal-build-system">A minimal build system</a></li>
                                <li><a href="#special-to-entangled">Special to Entangled</a></li>
                                </ul></li>
                                <li><a href="#incremental-implementation">Incremental implementation</a>
                                <ul>
                                <li><a href="#exceptions">Exceptions</a></li>
                                <li><a href="#first-layer-targets-and-actions">First Layer: targets and actions</a></li>
                                <li><a href="#second-layer-rules-and-triggers">Second Layer: rules and triggers</a></li>
                                <li><a href="#third-layer-the-scan">Third Layer: the scan</a></li>
                                <li><a href="#file-event-loop">File event loop</a></li>
                                <li><a href="#adding-watches">Adding watches</a></li>
                                <li><a href="#main-loop">Main loop</a></li>
                                </ul></li>
                                </ul>
                </nav></div>
        </div> 
</div>
<div class="footer">
</div>
</body>
</html>
